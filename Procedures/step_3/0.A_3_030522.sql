
---DROP PROCEDURE A_3_030522
CREATE PROCEDURE [dbo].[A_3_030522]
       
AS

BEGIN

BEGIN TRY
----
DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
SELECT CONCAT('STEP#12:PROP_ALL BEGIN BY YEAR/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP

--TRUNCATE TABLE PROP_ALL
DECLARE @ENDDATE_UPPER BIGINT,@ENDDATE_LOWER BIGINT,@STARTDATE_UPPER BIGINT,@STARTDATE_LOWER BIGINT
DECLARE  @YEAR INT
SELECT @YEAR=2021
WHILE @YEAR>=2020
BEGIN
-----
	--FULL CALENDAR YEAR
	DELETE FROM PROP_ALL WHERE STATEMENTYEAR=@YEAR
	SELECT @ENDDATE_LOWER=@YEAR*10000+0401,@ENDDATE_UPPER=(@YEAR+1)*10000+0331
	SELECT @STARTDATE_LOWER=(@YEAR-1)*10000+0401,@STARTDATE_UPPER=@YEAR*10000+331


	DELETE FROM PROP_ALL WHERE STATEMENTYEAR=@YEAR

	INSERT INTO PROP_ALL
		(EXID_PLID_PRID_YR,
		-------
		--ALIGN WITH INSERT_LPLIST_AVM
		EXID_PLID_PRID,
		PROPERTYNAME,
		EXATRANSACTIONID,
		PROSPECTUSLOANID,
		LOANID,
		PROPERTYID,
		SAMEPROPERTYID,
		CALC_NARRATIVE,
		HasVAL,
		HasORIG,
		HasUW,
		UWDATE,
		UW_CAPRATE,
		VAL_UW,
		UW_REV_ACTUAL_RATIO,
		UW_EXP_ACTUAL_RATIO,
		UW_NOI_ACTUAL_RATIO,
		REV_UW,
		EXP_UW,
		NOI_UW,
		NCF_UW,
		VALUATIONDATE,
		VALUATIONAMOUNT,
		PROPERTYADDRESS,
		PROPERTYCITY,
		PROPERTYSTATE,
		PROPERTYZIPCODE,
		PROPERTYCOUNTY,
		PROPERTYSUBTYPE,
		PROPERTYSUBTYPE_ASSIGNED,
		NCREIFRegion,
		NCREIFDivision,
		NCREIFMetro,
		Latitude,
		Longitude,
		YearBuilt,
		YearRenov,
		YearBuiltRenov,
		NUMUNITS,
		LOANORIGBALANCE,
		LOANORIGDATE,
		LOANORIGINATOR,
		LOANMATURITYDATE,
		LOANFIXEDVSFLOAT,
		LOANORIGTERM,
		LOANAMORTTERM,
		LOANIOPERIOD,
		LOANPURPOSE,
		LOANORIGLTV,
		LOANMATURITYLTV,
		LOANRATECAP,

		-------
		STATEMENTYEAR,
		STATEMENTBEGDATE_UPPER,
		STATEMENTBEGDATE_LOWER,
		STATEMENTENDDATE_UPPER,
		STATEMENTENDDATE_LOWER,
		NUM_LOANS,
		NUM_PROPS,
		EXA_PLID,
		LID_DD_Max,
		LID_PID_DD_Max,
		HasData,
		EstData,
		HasEvent,
		HasREV,
		EstREV,
		HasFF,
		EstFF,
		LOANCURRENTRATEMARGIN,
		DEBTSERVICE_IO_UW,
		DEBTSERVICE_AMORT_UW,
		DEBTSERVICE_CAP_UW,
		SAMEGEO
		)

		SELECT
		CONCAT(EXID_PLID_PRID,'_',@YEAR),
		-------
		--ALIGN WITH INSERT_LPLIST_AVM
		EXID_PLID_PRID,
		PROPERTYNAME,
		EXATRANSACTIONID,
		PROSPECTUSLOANID,
		LOANID,
		PROPERTYID,
		SAMEPROPERTYID,
		CASE WHEN ORIG_ERROR=1 THEN '/ORIGDATE=CONTRIDATE-2M/' END,
		HasVAL,
		HasORIG,
		HasUW,
		UWDATE,
		UW_CAPRATE,
		UW_VALUATION,
		UW_REV_ACTUAL_RATIO,
		UW_EXP_ACTUAL_RATIO,
		UW_NOI_ACTUAL_RATIO,
		UWREVENUE,
		UWOPERATINGEXPENSES,
		UWNOI,
		UWNCF,
		MOSTRECENTVALUATIONDATE,
		MOSTRECENTVALUE,
		PROPERTYADDRESS,
		PROPERTYCITY,
		PROPERTYSTATE,
		PROPERTYZIPCODE,
		PROPERTYCOUNTY,
		PROPERTYSUBTYPE,
		PROPERTYSUBTYPE_ASSIGNED,
		NCREIFRegion,
		NCREIFDivision,
		NCREIFMetro,
		Latitude,
		Longitude,
		YEARBUILT,
		YEARLASTRENOVATED,
		YEARBUILTRENOV,
		CURRENTNUMBEROFUNITSBEDSROOMS,
		TOTALLOANAMOUNTATORIGINATION,
		ORIGINATIONDATE,
		PROPERTYORIGINATOR,
		MATURITYDATE,
		(CASE WHEN CURRENTINDEXRATE>0 OR LOANRATEINDEX>0  OR RATECAPLIFETIME>0  OR RATECAPSTRIKE>0 THEN 'FLOAT' ELSE 'FIXED' END),
		LOANORIGTERM,
		LOANAMORTTERM,
		LOANIOPER,
		LOANPURPOSE,
		(CASE WHEN TOTALLOANAMOUNTATORIGINATION>0 AND VALUATIONAMOUNTATCONTRIBUTION>0 THEN (TOTALLOANAMOUNTATORIGINATION/VALUATIONAMOUNTATCONTRIBUTION) END),
		MATURITYLTV,
		RATECAPLIFETIME,

		------------------
		@YEAR,
		@STARTDATE_UPPER,
		@STARTDATE_LOWER,
		@ENDDATE_UPPER,
		@ENDDATE_LOWER,
		NUM_LOANS,
		NUM_PROPS,
		EXA_PLID,
		LID_DD_Max,
		LID_PID_DD_Max,
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		LOANRATEMARGIN,
		MONTHLYDEBTSERVICEIO*12,
		MONTHLYDEBTSERVICEAMORTIZING*12,
		MONTHLYDEBTSERVICEATCAP*12,
		SAMEGEO

	FROM  LPLIST_ALL L WHERE
	CURRENTNUMBEROFUNITSBEDSROOMS>=2 AND CURRENTNUMBEROFUNITSBEDSROOMS<10000
	AND SAMEPROPERTYID IS NOT NULL AND SAMEGEO IS NOT NULL

	--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	SELECT CONCAT('PROP_ALL INSERTED FOR YEAR=',@YEAR,'/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP

	---EXA_PLID WITH VAL,UW,REV IN YEAR
	--DECLARE @YEAR INT SELECT @YEAR=2021
	SELECT DISTINCT
		EXA_PLID=CONCAT(X.exatransactionid,'_',X.prospectusloanid),
		EXHIBITA_ORIGINATIONDATE=CASE WHEN X.ORIGINATIONDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.ORIGINATIONDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.ORIGINATIONDATE) END,
		EXHIBITA_VALUATIONDATEATCONTRIBUTION=CASE WHEN X.VALUATIONDATEATCONTRIBUTION>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.VALUATIONDATEATCONTRIBUTION) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.VALUATIONDATEATCONTRIBUTION) END,
		EXHIBITA_VALUATIONAMOUNTATCONTRIBUTION=X.VALUATIONAMOUNTATCONTRIBUTION,
		EXHIBITA_MATURITYLTV=X.MATURITYLTV,
		EXHIBITA_SCHEDULEDLOANBALANCEATMATURITY=X.SCHEDULEDLOANBALANCEATMATURITY,
		EXHIBITA_CONTRIBUTIONFINANCIALSASOFDATE=CASE WHEN X.CONTRIBUTIONFINANCIALSASOFDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) END,
		EXHIBITA_OCCUPANCYDATE=CASE WHEN X.OCCUPANCYDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.OCCUPANCYDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.OCCUPANCYDATE) END,
		EXHIBITA_SECONDMOSTRECENTFINANCIALENDDATE=CASE WHEN X.SECONDMOSTRECENTFINANCIALENDDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.SECONDMOSTRECENTFINANCIALENDDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.SECONDMOSTRECENTFINANCIALENDDATE) END,
		EXHIBITA_THIRDMOSTRECENTFINANCIALENDDATE=CASE WHEN X.THIRDMOSTRECENTFINANCIALENDDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.THIRDMOSTRECENTFINANCIALENDDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.THIRDMOSTRECENTFINANCIALENDDATE) END,
		EXHIBITA_NCFATCONTRIBUTION=X.NCFATCONTRIBUTION,
		EXHIBITA_NOIATCONTRIBUTION=X.NOIATCONTRIBUTION,
		EXHIBITA_OPERATINGEXPENSESATCONTRIBUTION=X.OPERATINGEXPENSESATCONTRIBUTION,
		EXHIBITA_PHYSICALOCCUPANCYATCONTRIBUTION=X.PHYSICALOCCUPANCYATCONTRIBUTION,
		EXHIBITA_REVENUEATCONTRIBUTION=X.REVENUEATCONTRIBUTION,
		EXHIBITA_SECONDMOSTRECENTEGI=X.SECONDMOSTRECENTEGI,
		EXHIBITA_SECONDMOSTRECENTEXPENSES=X.SECONDMOSTRECENTEXPENSES,
		EXHIBITA_SECONDMOSTRECENTNCF=X.SECONDMOSTRECENTNCF,
		EXHIBITA_SECONDMOSTRECENTNOI=X.SECONDMOSTRECENTNOI,
		EXHIBITA_THIRDMOSTRECENTEGI=X.THIRDMOSTRECENTEGI,
		EXHIBITA_THIRDMOSTRECENTEXPENSES=X.THIRDMOSTRECENTEXPENSES,
		EXHIBITA_THIRDMOSTRECENTNCF=X.THIRDMOSTRECENTNCF,
		EXHIBITA_THIRDMOSTRECENTNOI=X.THIRDMOSTRECENTNOI
	INTO #T_EXHIBITA
	FROM EXHIBITA X WHERE
	CASE WHEN X.VALUATIONDATEATCONTRIBUTION>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.VALUATIONDATEATCONTRIBUTION) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.VALUATIONDATEATCONTRIBUTION) END=@YEAR
	OR CASE WHEN X.CONTRIBUTIONFINANCIALSASOFDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) END=@YEAR
	OR CASE WHEN X.OCCUPANCYDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.OCCUPANCYDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.OCCUPANCYDATE) END=@YEAR
	OR CASE WHEN X.SECONDMOSTRECENTFINANCIALENDDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.SECONDMOSTRECENTFINANCIALENDDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.SECONDMOSTRECENTFINANCIALENDDATE) END=@YEAR
	OR CASE WHEN X.THIRDMOSTRECENTFINANCIALENDDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.THIRDMOSTRECENTFINANCIALENDDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.THIRDMOSTRECENTFINANCIALENDDATE) END=@YEAR
	OR YEAR(CASE WHEN X.ORIGINATIONDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.ORIGINATIONDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.ORIGINATIONDATE) END) =@YEAR

	--DATES
	UPDATE PROP_ALL SET EXHIBITA_VALUATIONDATEATCONTRIBUTION=X.EXHIBITA_VALUATIONDATEATCONTRIBUTION FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_VALUATIONDATEATCONTRIBUTION)=PROP_ALL.STATEMENTYEAR AND PROP_ALL.STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXHIBITA_ORIGINATIONDATE=X.EXHIBITA_ORIGINATIONDATE FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(DATEADD(M,-3,X.EXHIBITA_ORIGINATIONDATE))=PROP_ALL.STATEMENTYEAR AND PROP_ALL.STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXHIBITA_CONTRIBUTIONFINANCIALSASOFDATE=X.EXHIBITA_CONTRIBUTIONFINANCIALSASOFDATE FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_CONTRIBUTIONFINANCIALSASOFDATE)=PROP_ALL.STATEMENTYEAR AND PROP_ALL.STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXHIBITA_OCCUPANCYDATE=X.EXHIBITA_OCCUPANCYDATE FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_OCCUPANCYDATE)=PROP_ALL.STATEMENTYEAR AND PROP_ALL.STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXHIBITA_SECONDMOSTRECENTFINANCIALENDDATE=X.EXHIBITA_SECONDMOSTRECENTFINANCIALENDDATE FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_SECONDMOSTRECENTFINANCIALENDDATE)=PROP_ALL.STATEMENTYEAR AND PROP_ALL.STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXHIBITA_THIRDMOSTRECENTFINANCIALENDDATE=X.EXHIBITA_THIRDMOSTRECENTFINANCIALENDDATE FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_THIRDMOSTRECENTFINANCIALENDDATE)=PROP_ALL.STATEMENTYEAR AND PROP_ALL.STATEMENTYEAR=@YEAR

	--VALUATION DATE
	UPDATE PROP_ALL SET 
	EXHIBITA_VALUATIONAMOUNTATCONTRIBUTION=X.EXHIBITA_VALUATIONAMOUNTATCONTRIBUTION
	FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_VALUATIONDATEATCONTRIBUTION)=PROP_ALL.STATEMENTYEAR 
	AND PROP_ALL.STATEMENTYEAR=@YEAR

	--CONTRIBUTION DATE
	UPDATE PROP_ALL SET 
	EXHIBITA_REVENUEATCONTRIBUTION=X.EXHIBITA_REVENUEATCONTRIBUTION,
	EXHIBITA_OPERATINGEXPENSESATCONTRIBUTION=X.EXHIBITA_OPERATINGEXPENSESATCONTRIBUTION,
	EXHIBITA_NOIATCONTRIBUTION=X.EXHIBITA_NOIATCONTRIBUTION,
	EXHIBITA_NCFATCONTRIBUTION=X.EXHIBITA_NCFATCONTRIBUTION,
	EXHIBITA_PHYSICALOCCUPANCYATCONTRIBUTION=X.EXHIBITA_PHYSICALOCCUPANCYATCONTRIBUTION
	FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_CONTRIBUTIONFINANCIALSASOFDATE)=PROP_ALL.STATEMENTYEAR 
	AND PROP_ALL.STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	EXHIBITA_SECONDMOSTRECENTEGI=X.EXHIBITA_SECONDMOSTRECENTEGI,
	EXHIBITA_SECONDMOSTRECENTEXPENSES=X.EXHIBITA_SECONDMOSTRECENTEXPENSES,
	EXHIBITA_SECONDMOSTRECENTNCF=X.EXHIBITA_SECONDMOSTRECENTNCF,
	EXHIBITA_SECONDMOSTRECENTNOI=X.EXHIBITA_SECONDMOSTRECENTNOI 
	FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_SECONDMOSTRECENTFINANCIALENDDATE)=PROP_ALL.STATEMENTYEAR 
	AND PROP_ALL.STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	EXHIBITA_THIRDMOSTRECENTEGI=X.EXHIBITA_THIRDMOSTRECENTEGI,
	EXHIBITA_THIRDMOSTRECENTEXPENSES=X.EXHIBITA_THIRDMOSTRECENTEXPENSES,
	EXHIBITA_THIRDMOSTRECENTNCF=X.EXHIBITA_THIRDMOSTRECENTNCF,
	EXHIBITA_THIRDMOSTRECENTNOI=X.EXHIBITA_THIRDMOSTRECENTNOI 
	FROM #T_EXHIBITA X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND YEAR(X.EXHIBITA_THIRDMOSTRECENTFINANCIALENDDATE)=PROP_ALL.STATEMENTYEAR 
	AND PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_EXHIBITA

	--DECLARE @YEAR INT SELECT @YEAR=2021
	SELECT DISTINCT
	EXA_PLID=CONCAT(X.exatransactionid,'_',X.prospectusloanid),
	LPER_MOSTRECENTVALUATIONDATE=CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END,
	LPER_MOSTRECENTVALUE=X.MOSTRECENTVALUE
	INTO #T_LPER_1 FROM LPER X WHERE 
	CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 THEN 
	(SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END=@YEAR

	UPDATE PROP_ALL SET 
	LPER_MOSTRECENTVALUATIONDATE=(SELECT MAX(X.LPER_MOSTRECENTVALUATIONDATE) FROM #T_LPER_1 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_MOSTRECENTVALUE=(SELECT MAX(X.LPER_MOSTRECENTVALUE) FROM #T_LPER_1 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID) 
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_LPER_1


	SELECT DISTINCT
	EXA_PLID=CONCAT(X.exatransactionid,'_',X.prospectusloanid),
	LPER_PrecedingFYFinAsOfDate=CASE WHEN X.PrecedingFYFinAsOfDate>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.PrecedingFYFinAsOfDate) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.PrecedingFYFinAsOfDate) END,
	LPER_PrecedingFYRevenue=X.PrecedingFYRevenue,
	LPER_PrecedingFYOperatingExp=X.PrecedingFYOperatingExp,
	LPER_PRECEDINGFYNOI=X.PRECEDINGFYNOI,
	LPER_PRECEDINGFYNCF=X.PRECEDINGFYNCF,
	LPER_PrecedingFYPhysicalOcc=X.PrecedingFYPhysicalOcc
	INTO #T_LPER_2 FROM LPER X WHERE 
	CASE WHEN X.PrecedingFYFinAsOfDate>100000 THEN 
	(SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.PrecedingFYFinAsOfDate) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.PrecedingFYFinAsOfDate) END=@YEAR

	UPDATE PROP_ALL SET 
	LPER_PrecedingFYFinAsOfDate=(SELECT MAX(X.LPER_PrecedingFYFinAsOfDate) FROM #T_LPER_2 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_PrecedingFYRevenue=(SELECT MAX(X.LPER_PrecedingFYRevenue) FROM #T_LPER_2 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_PrecedingFYOperatingExp=(SELECT MAX(X.LPER_PrecedingFYOperatingExp) FROM #T_LPER_2 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_PRECEDINGFYNOI=(SELECT MAX(X.LPER_PRECEDINGFYNOI) FROM #T_LPER_2 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_PRECEDINGFYNCF=(SELECT MAX(X.LPER_PRECEDINGFYNCF) FROM #T_LPER_2 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_PrecedingFYPhysicalOcc=(SELECT MAX(X.LPER_PrecedingFYPhysicalOcc) FROM #T_LPER_2 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID)  
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_LPER_2

	SELECT DISTINCT
	EXA_PLID=CONCAT(X.exatransactionid,'_',X.prospectusloanid),
	LPER_SecondPrecFYFinAsOfDate=CASE WHEN X.SecondPrecFYFinAsOfDate>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.SecondPrecFYFinAsOfDate) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.SecondPrecFYFinAsOfDate) END,
	LPER_SecondPrecedingFYRevenue=X.SecondPrecedingFYRevenue,
	LPER_SecondPrecedingFYOpExp=X.SecondPrecedingFYOpExp,
	LPER_SecondPrecedingFYNOI=X.SecondPrecedingFYNOI,
	LPER_SecondPrecedingFYNCF=X.SecondPrecedingFYNCF,
	LPER_SecondPrecedingFYPhyOcc=X.SecondPrecedingFYPhyOcc
	INTO #T_LPER_3 FROM LPER X WHERE 
	CASE WHEN X.SecondPrecFYFinAsOfDate>100000 THEN 
	(SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.SecondPrecFYFinAsOfDate) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.SecondPrecFYFinAsOfDate) END=@YEAR

	UPDATE PROP_ALL SET 
	LPER_SecondPrecFYFinAsOfDate=(SELECT MAX(X.LPER_SecondPrecFYFinAsOfDate) FROM #T_LPER_3 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_SecondPrecedingFYRevenue=(SELECT MAX(X.LPER_SecondPrecedingFYRevenue) FROM #T_LPER_3 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_SecondPrecedingFYOpExp=(SELECT MAX(X.LPER_SecondPrecedingFYOpExp) FROM #T_LPER_3 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_SecondPrecedingFYNOI=(SELECT MAX(X.LPER_SecondPrecedingFYNOI) FROM #T_LPER_3 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_SecondPrecedingFYNCF=(SELECT MAX(X.LPER_SecondPrecedingFYNCF) FROM #T_LPER_3 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_SecondPrecedingFYPhyOcc=(SELECT MAX(X.LPER_SecondPrecedingFYPhyOcc) FROM #T_LPER_3 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID)
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_LPER_3

	SELECT DISTINCT
	EXA_PLID=CONCAT(X.exatransactionid,'_',X.prospectusloanid),
	LPER_MostRecentFinAsOfEndDate=CASE WHEN X.MostRecentFinAsOfEndDate>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MostRecentFinAsOfEndDate) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MostRecentFinAsOfEndDate) END,
	LPER_MostRecentFinAsOfStDate=CASE WHEN X.MostRecentFinAsOfStDate>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MostRecentFinAsOfStDate) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MostRecentFinAsOfStDate) END,
	LPER_MOSTRECENTREVENUE=X.MOSTRECENTREVENUE,
	LPER_MOSTRECENTOPERATINGEXP=X.MOSTRECENTOPERATINGEXP,
	LPER_MOSTRECENTNOI=X.MOSTRECENTNOI,
	LPER_MOSTRECENTNCF=X.MOSTRECENTNCF,
	LPER_MOSTRECENTPHYSICALOCCUPANCY=X.MostRecentPhysicalOcc
	INTO #T_LPER_4 FROM LPER X WHERE 
	CASE WHEN X.MostRecentFinAsOfEndDate>100000 
	THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.MostRecentFinAsOfEndDate) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.MostRecentFinAsOfEndDate) END=@YEAR

	UPDATE PROP_ALL SET 
	LPER_MostRecentFinAsOfEndDate=(SELECT MAX(X.LPER_MostRecentFinAsOfEndDate) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID),
	LPER_MostRecentFinAsOfStDate=(SELECT MIN(X.LPER_MostRecentFinAsOfStDate) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID) 
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	LPER_MOSTRECENTREVENUE=(SELECT MAX(X.LPER_MOSTRECENTREVENUE) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND X.LPER_MostRecentFinAsOfEndDate=PROP_ALL.LPER_MostRecentFinAsOfEndDate AND X.LPER_MostRecentFinAsOfStDate=PROP_ALL.LPER_MostRecentFinAsOfStDate),
	LPER_MOSTRECENTOPERATINGEXP=(SELECT MAX(X.LPER_MOSTRECENTOPERATINGEXP) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND X.LPER_MostRecentFinAsOfEndDate=PROP_ALL.LPER_MostRecentFinAsOfEndDate AND X.LPER_MostRecentFinAsOfStDate=PROP_ALL.LPER_MostRecentFinAsOfStDate),
	LPER_MOSTRECENTNOI=(SELECT MAX(X.LPER_MOSTRECENTNOI) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND X.LPER_MostRecentFinAsOfEndDate=PROP_ALL.LPER_MostRecentFinAsOfEndDate AND X.LPER_MostRecentFinAsOfStDate=PROP_ALL.LPER_MostRecentFinAsOfStDate),
	LPER_MOSTRECENTNCF=(SELECT MAX(X.LPER_MOSTRECENTNCF) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND X.LPER_MostRecentFinAsOfEndDate=PROP_ALL.LPER_MostRecentFinAsOfEndDate AND X.LPER_MostRecentFinAsOfStDate=PROP_ALL.LPER_MostRecentFinAsOfStDate),
	LPER_MostRecentPhysicalOcc=(SELECT MAX(X.LPER_MOSTRECENTPHYSICALOCCUPANCY) FROM #T_LPER_4 X WHERE X.EXA_PLID=PROP_ALL.EXA_PLID AND X.LPER_MostRecentFinAsOfEndDate=PROP_ALL.LPER_MostRecentFinAsOfEndDate AND X.LPER_MostRecentFinAsOfStDate=PROP_ALL.LPER_MostRecentFinAsOfStDate)
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_LPER_4

	--DECLARE @YEAR INT SELECT @YEAR=2021
	SELECT DISTINCT
	EXID_PLID_PRID=CONCAT(X.exatransactionid,'_',X.prospectusloanid,'_',X.PROPERTYid),
	PROPERTY_VALUATIONDATEATCONTRIBUTION=CASE WHEN X.VALUATIONDATEATCONTRIBUTION>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END,
	PROPERTY_VALUATIONAMOUNTATCONTRIBUTION=X.VALUATIONAMOUNTATCONTRIBUTION
	INTO #T_PROP_1 FROM PROPERTY X WHERE 
	CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 
	THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.VALUATIONDATEATCONTRIBUTION) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.VALUATIONDATEATCONTRIBUTION) END=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_VALUATIONDATEATCONTRIBUTION=(SELECT MAX(X.PROPERTY_VALUATIONDATEATCONTRIBUTION) FROM #T_PROP_1 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_VALUATIONAMOUNTATCONTRIBUTION=(SELECT MAX(X.PROPERTY_VALUATIONAMOUNTATCONTRIBUTION) FROM #T_PROP_1 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID)
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR
	DROP TABLE #T_PROP_1


	SELECT DISTINCT
	EXID_PLID_PRID=CONCAT(X.exatransactionid,'_',X.prospectusloanid,'_',X.PROPERTYid),
	PROPERTY_MOSTRECENTVALUATIONDATE=CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END,
	PROPERTY_MOSTRECENTVALUE=X.MOSTRECENTVALUE
	INTO #T_PROP_2 FROM PROPERTY X WHERE 
	CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 
	THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_MOSTRECENTVALUATIONDATE=(SELECT MAX(X.PROPERTY_MOSTRECENTVALUATIONDATE) FROM #T_PROP_2 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_MOSTRECENTVALUE=(SELECT MAX(X.PROPERTY_MOSTRECENTVALUE) FROM #T_PROP_2 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID)
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR
	DROP TABLE #T_PROP_2

	SELECT DISTINCT
	EXID_PLID_PRID=CONCAT(X.exatransactionid,'_',X.prospectusloanid,'_',X.PROPERTYid),
	PROPERTY_CONTRIBUTIONFINANCIALSASOFDATE=CASE WHEN X.CONTRIBUTIONFINANCIALSASOFDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) END,
	PROPERTY_REVENUEATCONTRIBUTION=X.REVENUEATCONTRIBUTION,
	PROPERTY_OPERATINGEXPENSESATCONTRIBUTION=X.OPERATINGEXPENSESATCONTRIBUTION,
	PROPERTY_NOIATCONTRIBUTION=X.NOIATCONTRIBUTION,
	PROPERTY_NCFATCONTRIBUTION=X.NCFATCONTRIBUTION,
	PROPERTY_PHYSICALOCCUPANCYATCONTRIBUTION=X.PHYSICALOCCUPANCYATCONTRIBUTION
	INTO #T_PROP_3 FROM PROPERTY X WHERE 
	CASE WHEN X.CONTRIBUTIONFINANCIALSASOFDATE>100000 
	THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.CONTRIBUTIONFINANCIALSASOFDATE) END=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_CONTRIBUTIONFINANCIALSASOFDATE=(SELECT MAX(X.PROPERTY_CONTRIBUTIONFINANCIALSASOFDATE) FROM #T_PROP_3 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_REVENUEATCONTRIBUTION=(SELECT MAX(X.PROPERTY_REVENUEATCONTRIBUTION) FROM #T_PROP_3 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_OPERATINGEXPENSESATCONTRIBUTION=(SELECT MAX(X.PROPERTY_OPERATINGEXPENSESATCONTRIBUTION) FROM #T_PROP_3 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID), 
	PROPERTY_NOIATCONTRIBUTION=(SELECT MAX(X.PROPERTY_NOIATCONTRIBUTION) FROM #T_PROP_3 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_NCFATCONTRIBUTION=(SELECT MAX(X.PROPERTY_NCFATCONTRIBUTION) FROM #T_PROP_3 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_PHYSICALOCCUPANCYATCONTRIBUTION=(SELECT MAX(X.PROPERTY_PHYSICALOCCUPANCYATCONTRIBUTION) FROM #T_PROP_3 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID)
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_PROP_3

	SELECT DISTINCT
	EXID_PLID_PRID=CONCAT(X.exatransactionid,'_',X.prospectusloanid,'_',X.PROPERTYid),
	PROPERTY_PRECEDINGFISCALYEARFINANCIALASOFDATE=CASE WHEN X.PRECEDINGFISCALYEARFINANCIALASOFDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.PRECEDINGFISCALYEARFINANCIALASOFDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.PRECEDINGFISCALYEARFINANCIALASOFDATE) END,
	PROPERTY_PRECEDINGFISCALYEARREVENUE=X.PRECEDINGFISCALYEARREVENUE,
	PROPERTY_PRECEDINGFYOPEXP=X.PRECEDINGFYOPEXP,
	PROPERTY_PRECEDINGFYNOI=X.PRECEDINGFYNOI,
	PROPERTY_PRECEDINGFYNCF=X.PRECEDINGFYNCF,
	PROPERTY_PRECEDINGFYPHYSOCCUP=X.PRECEDINGFYPHYSOCCUP
	INTO #T_PROP_4 FROM PROPERTY X WHERE 
	CASE WHEN X.PRECEDINGFISCALYEARFINANCIALASOFDATE>100000 
	THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.PRECEDINGFISCALYEARFINANCIALASOFDATE) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.PRECEDINGFISCALYEARFINANCIALASOFDATE) END=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_PRECEDINGFISCALYEARFINANCIALASOFDATE=(SELECT MAX(X.PROPERTY_PRECEDINGFISCALYEARFINANCIALASOFDATE) FROM #T_PROP_4 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) ,
	PROPERTY_PRECEDINGFISCALYEARREVENUE=(SELECT MAX(X.PROPERTY_PRECEDINGFISCALYEARREVENUE) FROM #T_PROP_4 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) ,
	PROPERTY_PRECEDINGFYOPEXP=(SELECT MAX(X.PROPERTY_PRECEDINGFYOPEXP) FROM #T_PROP_4 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) ,
	PROPERTY_PRECEDINGFYNOI=(SELECT MAX(X.PROPERTY_PRECEDINGFYNOI) FROM #T_PROP_4 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) ,
	PROPERTY_PRECEDINGFYNCF=(SELECT MAX(X.PROPERTY_PRECEDINGFYNCF) FROM #T_PROP_4 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) ,
	PROPERTY_PRECEDINGFYPHYSOCCUP=(SELECT MAX(X.PROPERTY_PRECEDINGFYPHYSOCCUP) FROM #T_PROP_4 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) 
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_PROP_4

	SELECT DISTINCT
	EXID_PLID_PRID=CONCAT(X.exatransactionid,'_',X.prospectusloanid,'_',X.PROPERTYid),
	PROPERTY_SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE=CASE WHEN X.SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE) END,
	PROPERTY_SECPRECEDINGFYREVENUE=X.SECPRECEDINGFYREVENUE,
	PROPERTY_SECPRECEDINGFYOPEXP=X.SECPRECEDINGFYOPEXP,
	PROPERTY_SECPRECEDINGFYNOI=X.SECPRECEDINGFYNOI,
	PROPERTY_SECONDPRECEDINGFYNCF=X.SECONDPRECEDINGFYNCF,
	PROPERTY_SECPRECEDINGFYPHYSOCC=X.SECPRECEDINGFYPHYSOCC
	INTO #T_PROP_5 FROM PROPERTY X WHERE 
	CASE WHEN X.SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE>100000 
	THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE) 
	ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE) END=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE=(SELECT MAX(X.PROPERTY_SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE) FROM #T_PROP_5 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_SECPRECEDINGFYREVENUE=(SELECT MAX(X.PROPERTY_SECPRECEDINGFYREVENUE) FROM #T_PROP_5 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID), 
	PROPERTY_SECPRECEDINGFYOPEXP=(SELECT MAX(X.PROPERTY_SECPRECEDINGFYOPEXP) FROM #T_PROP_5 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID), 
	PROPERTY_SECPRECEDINGFYNOI=(SELECT MAX(X.PROPERTY_SECPRECEDINGFYNOI) FROM #T_PROP_5 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_SECONDPRECEDINGFYNCF=(SELECT MAX(X.PROPERTY_SECONDPRECEDINGFYNCF) FROM #T_PROP_5 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_SECPRECEDINGFYPHYSOCC=(SELECT MAX(X.PROPERTY_SECPRECEDINGFYPHYSOCC) FROM #T_PROP_5 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID)
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_PROP_5

	SELECT DISTINCT
	EXID_PLID_PRID=CONCAT(X.exatransactionid,'_',X.prospectusloanid,'_',X.PROPERTYid),
	PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=CASE WHEN X.MOSTRECENTFINANCIALASOFENDDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTFINANCIALASOFENDDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTFINANCIALASOFENDDATE) END,
	PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=CASE WHEN X.MOSTRECENTFINANCIALASOFSTARTDATE>100000 THEN (SELECT DATEDATE FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTFINANCIALASOFSTARTDATE) ELSE (SELECT DATEDATE FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTFINANCIALASOFSTARTDATE) END,
	PROPERTY_MOSTRECENTREVENUE=X.MOSTRECENTREVENUE,
	PROPERTY_MOSTRECENTOPERATINGEXP=X.MOSTRECENTOPERATINGEXP,
	PROPERTY_MOSTRECENTNOI=X.MOSTRECENTNOI,
	PROPERTY_MOSTRECENTNCF=X.MOSTRECENTNCF,
	PROPERTY_MOSTRECENTPHYSICALOCCUPANCY=X.MOSTRECENTPHYSICALOCCUPANCY
	INTO #T_PROP_6 FROM PROPERTY X WHERE CASE WHEN X.MOSTRECENTFINANCIALASOFENDDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTFINANCIALASOFENDDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTFINANCIALASOFENDDATE) END=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=(SELECT MAX(X.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID),
	PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=(SELECT MIN(X.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID) 
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	PROPERTY_MOSTRECENTREVENUE=(SELECT MAX(X.PROPERTY_MOSTRECENTREVENUE) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID AND X.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE AND X.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE),
	PROPERTY_MOSTRECENTOPERATINGEXP=(SELECT MAX(X.PROPERTY_MOSTRECENTOPERATINGEXP) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID AND X.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE AND X.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE),
	PROPERTY_MOSTRECENTNOI=(SELECT MAX(X.PROPERTY_MOSTRECENTNOI) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID AND X.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE AND X.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE),
	PROPERTY_MOSTRECENTNCF=(SELECT MAX(X.PROPERTY_MOSTRECENTNCF) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID AND X.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE AND X.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE),
	PROPERTY_MOSTRECENTPHYSICALOCCUPANCY=(SELECT MAX(X.PROPERTY_MOSTRECENTPHYSICALOCCUPANCY) FROM #T_PROP_6 X WHERE X.EXID_PLID_PRID=PROP_ALL.EXID_PLID_PRID AND X.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFENDDATE AND X.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE=PROP_ALL.PROPERTY_MOSTRECENTFINANCIALASOFSTARTDATE) 
	WHERE PROP_ALL.STATEMENTYEAR=@YEAR

	DROP TABLE #T_PROP_6

	--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	SELECT CONCAT('PROP_ALL DATA PULLED FROM BIG3/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	--SELECT * FROM PROP_ALL WHERE STATEMENTYEAR=@YEAR ORDER BY UWDATE DESC


	--ORIG
	--DECLARE @YEAR INT SELECT @YEAR=2021
	UPDATE PROP_ALL SET 
	HasORIG=0,
	EXID_PLID_PRID_ORIG=NULL,
	EXA_PLID_ORIG=NULL, 
	LID_DD_ORIG=NULL
	WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET HasORIG=1 WHERE YEAR(LOANORIGDATE)=@YEAR AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXID_PLID_PRID_ORIG=EXID_PLID_PRID WHERE HasORIG=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXA_PLID_ORIG=EXA_PLID WHERE HasORIG=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LID_DD_ORIG=LID_DD_Max WHERE HasORIG= 1AND STATEMENTYEAR=@YEAR

	--DECLARE @YEAR INT SELECT @YEAR=2021
	UPDATE PROP_ALL SET 
	HasEVENT=0,
	LOANPREPAYMENT=NULL,
	LOANASSUMPTION=NULL,
	LOANWATCHLIST=NULL,
	LOANTRANSFERTOSPECIAL=NULL,
	LOANMODIFICATION=NULL,
	LOANLIQUIDATION=NULL,
	LOANDQ=NULL,
	LOANPREPAYMENT_M=NULL,
	LOANASSUMPTION_M=NULL,
	LOANWATCHLIST_M=NULL,
	LOANTRANSFERTOSPECIAL_M=NULL,
	LOANMODIFICATION_M=NULL,
	LOANLIQUIDATION_M=NULL,
	LOANDQ_M=NULL,
	LOAN_LIQ_PPY_CODE=NULL,
	LOAN_MODIFY_CODE=NULL,
	LOAN_DQ_CODE=NULL,
	LOAN_DEFEASANCE_STATUS=NULL,
	LOAN_WORKOUT_STRATEGY=NULL

	WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANBEGINBALANCE=(SELECT MAX(CurrentBeginningSchedBal) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID 
		AND DistributionDate>=@YEAR*10000 AND DistributionDate<(@YEAR+1)*10000 AND YEAR(LOANORIGDATE)<STATEMENTYEAR)  WHERE LOANBEGINBALANCE is NULL and STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANENDBALANCE=(SELECT MIN(CurrentEndingSchedBal) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID 
		AND DistributionDate>=@YEAR*10000 AND DistributionDate<(@YEAR+1)*10000)  WHERE LOANENDBALANCE is NULL and STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANCURRENTNOTERATE=(SELECT MAX(CurrentNoteRate) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID 
		AND DistributionDate>=@YEAR*10000 AND DistributionDate<(@YEAR+1)*10000)  WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANPREPAYMENT=(SELECT DateDate FROM DATECONVERT WHERE 
	DateLong=(SELECT MIN(LiquidationPrepaymentDate) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND LiquidationPrepaymentDate<(@YEAR+1)*10000 AND LiquidationPrepaymentDate>@YEAR*10000 AND 
				LiquidationPrepaymentCode<>3 AND LiquidationPrepaymentCode<>6 AND LiquidationPrepaymentCode<>7)) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANASSUMPTION=(SELECT DateDate FROM DATECONVERT WHERE DateLong=
	(SELECT MIN(DateOfAssumption) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DateOfAssumption<(@YEAR+1)*10000 AND DateOfAssumption>@YEAR*10000)) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANWATCHLIST=(SELECT DateDate FROM DATECONVERT WHERE DateLong=
	(SELECT MIN(DateAddedToServWatchlist) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DateAddedToServWatchlist<(@YEAR+1)*10000 AND DateAddedToServWatchlist>@YEAR*10000)) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANTRANSFERTOSPECIAL=(SELECT DateDate FROM DATECONVERT WHERE DateLong=
	(SELECT MIN(MostRecentSpecialServicerTransferDate) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND MostRecentSpecialServicerTransferDate<(@YEAR+1)*10000 AND MostRecentSpecialServicerTransferDate>@YEAR*10000)) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANMODIFICATION=(SELECT DateDate FROM DATECONVERT WHERE DateLong=
	(SELECT MIN(DateOfLastModification) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DateOfLastModification<(@YEAR+1)*10000 AND DateOfLastModification>@YEAR*10000)) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANLIQUIDATION=(SELECT DateDate FROM DATECONVERT WHERE DateLong=
	(SELECT MIN(LiquidationPrepaymentDate) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND LiquidationPrepaymentDate<(@YEAR+1)*10000 AND LiquidationPrepaymentDate>@YEAR*10000 AND 
	(LiquidationPrepaymentCode=3 OR LiquidationPrepaymentCode=6 OR LiquidationPrepaymentCode=7))) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANDQ=(SELECT DateDate FROM DATECONVERT WHERE DateLong=
	(SELECT MIN(DistributionDate) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID and DistributionDate<(@YEAR+1)*10000 AND DistributionDate>@YEAR*10000 AND
		(PaymentStatusofLoanfkaStatusofLoan='5' OR PaymentStatusofLoanfkaStatusofLoan='4' OR PaymentStatusofLoanfkaStatusofLoan='3' OR PaymentStatusofLoanfkaStatusofLoan='2'))) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOAN_LIQ_PPY_CODE=(SELECT max(LiquidationPrepaymentCode) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DistributionDate<(@YEAR+1)*10000 AND DistributionDate>@YEAR*10000)WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOAN_MODIFY_CODE=(SELECT max(ModificationCode) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DistributionDate<(@YEAR+1)*10000 AND DistributionDate>@YEAR*10000) WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOAN_DQ_CODE=(SELECT MAX(CAST(PaymentStatusofLoanfkaStatusofLoan AS INT)) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID and DistributionDate<(@YEAR+1)*10000 AND DistributionDate>@YEAR*10000 AND
		(PaymentStatusofLoanfkaStatusofLoan='5' OR PaymentStatusofLoanfkaStatusofLoan='4' OR PaymentStatusofLoanfkaStatusofLoan='3' OR PaymentStatusofLoanfkaStatusofLoan='2'))WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOAN_DEFEASANCE_STATUS=(SELECT max(DefeasanceStatus) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DistributionDate<(@YEAR+1)*10000 AND DistributionDate>@YEAR*10000) WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOAN_WORKOUT_STRATEGY=(SELECT max(WorkoutStrategy) FROM LPER WHERE LPER.LOANID=PROP_ALL.LOANID AND DistributionDate<(@YEAR+1)*10000 AND DistributionDate>@YEAR*10000) WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET LOANPREPAYMENT_M=DATEDIFF(M,LOANORIGDATE,LOANPREPAYMENT) WHERE LOANORIGDATE IS NOT NULL AND LOANPREPAYMENT IS NOT NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOANASSUMPTION_M=DATEDIFF(M,LOANORIGDATE,LOANASSUMPTION) WHERE LOANORIGDATE IS NOT NULL AND LOANASSUMPTION IS NOT NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOANWATCHLIST_M=DATEDIFF(M,LOANORIGDATE,LOANWATCHLIST) WHERE LOANORIGDATE IS NOT NULL AND LOANWATCHLIST IS NOT NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOANTRANSFERTOSPECIAL_M=DATEDIFF(M,LOANORIGDATE,LOANTRANSFERTOSPECIAL) WHERE LOANORIGDATE IS NOT NULL AND LOANTRANSFERTOSPECIAL IS NOT NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOANMODIFICATION_M=DATEDIFF(M,LOANORIGDATE,LOANMODIFICATION) WHERE LOANORIGDATE IS NOT NULL AND LOANMODIFICATION IS NOT NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOANLIQUIDATION_M=DATEDIFF(M,LOANORIGDATE,LOANLIQUIDATION) WHERE LOANORIGDATE IS NOT NULL AND LOANLIQUIDATION IS NOT NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LOANDQ_M=DATEDIFF(M,LOANORIGDATE,LOANDQ) WHERE LOANORIGDATE IS NOT NULL AND LOANDQ IS NOT NULL AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	HasEVENT=0,
	LOANPREPAYMENT=NULL,
	LOANASSUMPTION=NULL,
	LOANWATCHLIST=NULL,
	LOANTRANSFERTOSPECIAL=NULL,
	LOANMODIFICATION=NULL,
	LOANLIQUIDATION=NULL,
	LOANDQ=NULL,
	LOANPREPAYMENT_M=NULL,
	LOANASSUMPTION_M=NULL,
	LOANWATCHLIST_M=NULL,
	LOANTRANSFERTOSPECIAL_M=NULL,
	LOANMODIFICATION_M=NULL,
	LOANLIQUIDATION_M=NULL,
	LOANDQ_M=NULL,
	LOAN_LIQ_PPY_CODE=NULL,
	LOAN_MODIFY_CODE=NULL,
	LOAN_DQ_CODE=NULL,
	LOAN_DEFEASANCE_STATUS=NULL,
	LOAN_WORKOUT_STRATEGY=NULL
	WHERE 
	(LOANPREPAYMENT_M<3 OR
	LOANASSUMPTION_M<1 OR
	LOANWATCHLIST_M<1 OR
	LOANTRANSFERTOSPECIAL_M<1 OR
	LOANMODIFICATION_M<1 OR
	LOANLIQUIDATION_M<1 OR
	LOANDQ_M<1)
	AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET HasEVENT=1
	WHERE (LOANENDBALANCE>0 OR LOANPREPAYMENT IS NOT NULL OR LOANASSUMPTION IS NOT NULL OR LOANWATCHLIST IS NOT NULL OR LOANTRANSFERTOSPECIAL IS NOT NULL
	OR LOANMODIFICATION IS NOT NULL OR LOANLIQUIDATION IS NOT NULL OR LOANDQ IS NOT NULL)
	AND STATEMENTYEAR=@YEAR 

	--UW
	UPDATE PROP_ALL SET 
	HasUW=0,
	EXID_PLID_PRID_UW=NULL, 
	EXA_PLID_UW=NULL
	WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	HasUW=1,
	EXA_PLID_UW=EXA_PLID  
	WHERE YEAR(UWDATE)=@YEAR AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET
	EXID_PLID_PRID_UW=EXID_PLID_PRID
	WHERE HasUW=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET
	UWDATE=NULL,
	VAL_UW=NULL,
	REV_UW=NULL,
	EXP_UW=NULL,
	NOI_UW=NULL,
	NCF_UW=NULL,
	DEBTSERVICE_IO_UW=NULL,
	DEBTSERVICE_AMORT_UW=NULL,
	DEBTSERVICE_CAP_UW=NULL
	WHERE HasUW=0 AND STATEMENTYEAR=@YEAR


	--VAL..FROM LPLIST_ALL
	UPDATE PROP_ALL SET 
	HasVAL=0,
	EXID_PLID_PRID_VAL=NULL,
	EXA_PLID_VAL=NULL,
	LID_DD_VAL=NULL,
	LID_PRID_DD_VAL=NULL,
	EXA_PLID_VALFIELDNAME=NULL,
	LID_PRID_DD_VALFIELDNAME=NULL,
	LID_DD_VALFIELDNAME=NULL
	WHERE STATEMENTYEAR=@YEAR

	----
	UPDATE PROP_ALL SET
	HasVAL=1,
	EXA_PLID_VALFIELDNAME='VALUATIONAMOUNTATCONTRIBUTION',
	EXA_PLID_VAL=
	(SELECT MAX(EXA_PLID) FROM EXHIBITA X WHERE X.ExATransactionID=PROP_ALL.ExATransactionID AND X.ProspectusLoanId=PROP_ALL.ProspectusLoanId AND 
	CASE WHEN X.VALUATIONDATEATCONTRIBUTION>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.VALUATIONDATEATCONTRIBUTION) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.VALUATIONDATEATCONTRIBUTION) END
	=@YEAR)

	WHERE YEAR(VALUATIONDATE)=@YEAR AND STATEMENTYEAR=@YEAR
	----

	UPDATE PROP_ALL SET
	HasVAL=1,
	LID_PRID_DD_VALFIELDNAME='MOSTRECENTVALUE',
	LID_PRID_DD_VAL=(SELECT MAX(LID_PID_DD) FROM PROPERTY X WHERE X.LOANID=PROP_ALL.LOANID AND X.PROPERTYID=PROP_ALL.PROPERTYID AND 
	CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END
	=@YEAR)
	WHERE YEAR(VALUATIONDATE)=@YEAR AND STATEMENTYEAR=@YEAR AND HasVAL=0

	---DECLARE @YEAR INT SELECT @YEAR=2021
	UPDATE PROP_ALL SET
	HasVAL=1,
	LID_DD_VALFIELDNAME='MOSTRECENTVALUE',
	LID_DD_VAL=(SELECT MAX(LID_DD) FROM LPER X WHERE X.LOANID=PROP_ALL.LOANID AND 
	CASE WHEN X.MOSTRECENTVALUATIONDATE>100000 THEN (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATELONG=X.MOSTRECENTVALUATIONDATE) ELSE (SELECT YEAR(DATEDATE) FROM DATECONVERT WHERE DATEDATELONG=X.MOSTRECENTVALUATIONDATE) END
	=@YEAR)
	WHERE YEAR(VALUATIONDATE)=@YEAR AND STATEMENTYEAR=@YEAR AND HasVAL=0

	UPDATE PROP_ALL SET
	EXID_PLID_PRID_VAL=EXID_PLID_PRID
	WHERE HasVAL=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	VALUATIONDATE=NULL,
	VALUATIONAMOUNT=NULL,
	EXID_PLID_PRID_VAL=NULL,
	EXA_PLID_VAL=NULL,
	LID_DD_VAL=NULL,
	LID_PRID_DD_VAL=NULL,
	EXA_PLID_VALFIELDNAME=NULL,
	LID_PRID_DD_VALFIELDNAME=NULL,
	LID_DD_VALFIELDNAME=NULL
	WHERE STATEMENTYEAR=@YEAR AND HASVAL=0

	--REV
	UPDATE PROP_ALL SET HasREV=0,
	LID_PID_DD_REV=NULL,
	LID_PID_DD_REVFIELDNAME=NULL,
	LID_DD_REV=NULL,
	LID_DD_REVFIELDNAME=NULL,
	EXA_PLID_REV=NULL,
	EXA_PLID_REVFIELDNAME=NULL,
	REV=NULL, 
	EXPENSE=NULL,
	NOI=NULL,
	OCCUP=NULL,
	DEBTSERVICE=NULL,
	STATEMENTBEGDATE=NULL,
	STATEMENTENDDATE=NULL,
	STATEMENTBEGDATE_REV=NULL,
	STATEMENTENDDATE_REV=NULL,
	STATEMENTBEGDATE_FF=NULL,
	STATEMENTENDDATE_FF=NULL
	WHERE STATEMENTYEAR=@YEAR

	---PROPERTY,PRECEDINGFISCALYEARFINANCIALASOFDATE,PRECEDINGFISCALYEARREVENUE
	UPDATE PROP_ALL SET LID_PID_DD_REV=(SELECT MAX(LID_PID_DD) FROM PROPERTY WHERE LOANID=PROP_ALL.LOANID AND PROPERTYID=PROP_ALL.PROPERTYID 
		AND PRECEDINGFISCALYEARFINANCIALASOFDATE>=STATEMENTENDDATE_LOWER AND PRECEDINGFISCALYEARFINANCIALASOFDATE<=STATEMENTENDDATE_UPPER) WHERE LID_PID_DD_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	LID_PID_DD_REVFIELDNAME='PRECEDINGFISCALYEARREVENUE',
	REV=(SELECT MAX(PRECEDINGFISCALYEARREVENUE) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND PRECEDINGFISCALYEARREVENUE>0),
	EXPENSE=(SELECT MAX(PRECEDINGFYOPEXP) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND PRECEDINGFYOPEXP>0),
	NOI=(SELECT MAX(PRECEDINGFYNOI) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND PRECEDINGFYNOI>0),
	NCF=(SELECT MAX(PRECEDINGFYNCF) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND PRECEDINGFYNCF>0),
	OCCUP=(SELECT MAX(PRECEDINGFYPHYSOCCUP) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND PRECEDINGFYPHYSOCCUP>0),
	DEBTSERVICE=(SELECT MAX(PRECEDINGFYDEBTSERVAMT) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND PRECEDINGFYDEBTSERVAMT>0),
	STATEMENTENDDATE_REV=(SELECT EOMONTH(DateDate) FROM DATECONVERT WHERE DateLong=(SELECT MAX(PRECEDINGFISCALYEARFINANCIALASOFDATE) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV))
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND LID_PID_DD_REV IS NOT NULL

	---PROPERTY,SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE,SECPRECEDINGFYREVENUE
	UPDATE PROP_ALL SET LID_PID_DD_REV=(SELECT MAX(LID_PID_DD) FROM PROPERTY WHERE LOANID=PROP_ALL.LOANID AND PROPERTYID=PROP_ALL.PROPERTYID 
		AND SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE>=STATEMENTENDDATE_LOWER AND SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE<=STATEMENTENDDATE_UPPER) WHERE LID_PID_DD_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	LID_PID_DD_REVFIELDNAME='SECPRECEDINGFYREVENUE',
	REV=(SELECT MAX(SECPRECEDINGFYREVENUE) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND SECPRECEDINGFYREVENUE>0),
	EXPENSE=(SELECT MAX(SECPRECEDINGFYOPEXP) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND SECPRECEDINGFYOPEXP>0),
	NOI=(SELECT MAX(SECPRECEDINGFYNOI) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND SECPRECEDINGFYNOI>0),
	NCF=(SELECT MAX(SECONDPRECEDINGFYNCF) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND SECONDPRECEDINGFYNCF>0),
	DEBTSERVICE=(SELECT MAX(SECPRECEDINGFYDEBTSERVAMT) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND SECPRECEDINGFYDEBTSERVAMT>0),
	OCCUP=(SELECT MAX(SECPRECEDINGFYPHYSOCC) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV AND SECPRECEDINGFYPHYSOCC>0),
	STATEMENTENDDATE_REV=(SELECT MAX(EOMONTH(DateDate)) FROM DATECONVERT WHERE DateLong=(SELECT MAX(SECONDPRECEDINGFISCALYEARFINANCIALASOFDATE) FROM PROPERTY WHERE LID_PID_DD=LID_PID_DD_REV))
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND LID_PID_DD_REV IS NOT NULL

	---LPER,PrecedingFYFinAsOfDate,PrecedingFYRevenue
	UPDATE PROP_ALL SET LID_DD_REV=(SELECT MAX(LID_DD) FROM LPER WHERE LOANID=PROP_ALL.LOANID AND PrecedingFYFinAsOfDate>=STATEMENTENDDATE_LOWER 
		AND PrecedingFYFinAsOfDate<=STATEMENTENDDATE_UPPER) WHERE NUM_PROPS=1 AND LID_DD_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	LID_DD_REVFIELDNAME='PrecedingFYRevenue',
	REV=(SELECT MAX(PrecedingFYRevenue) FROM LPER WHERE LID_DD=LID_DD_REV AND PrecedingFYRevenue>0),
	EXPENSE=(SELECT MAX(PrecedingFYOperatingExp) FROM LPER WHERE LID_DD=LID_DD_REV AND PrecedingFYOperatingExp>0),
	NOI=(SELECT MAX(PrecedingFYNOI) FROM LPER WHERE LID_DD=LID_DD_REV AND PrecedingFYNOI>0),
	NCF=(SELECT MAX(PrecedingFYNCF) FROM LPER WHERE LID_DD=LID_DD_REV AND PrecedingFYNCF>0),
	DEBTSERVICE=(SELECT MAX(PrecedingFYDebtSvcAmount) FROM LPER WHERE LID_DD=LID_DD_REV AND PrecedingFYDebtSvcAmount>0),
	OCCUP=(SELECT MAX(PrecedingFYPhysicalOcc) FROM LPER WHERE LID_DD=LID_DD_REV AND PrecedingFYPhysicalOcc>0),
	STATEMENTENDDATE_REV=(SELECT EOMONTH(DateDate) FROM DATECONVERT WHERE DateLong=(SELECT MAX(PrecedingFYFinAsOfDate) FROM LPER WHERE LID_DD=LID_DD_REV))
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND LID_DD_REV IS NOT NULL

	---LPER,SecondPrecFYFinAsOfDate,SecondPrecedingFYRevenue
	UPDATE PROP_ALL SET LID_DD_REV=(SELECT MAX(LID_DD) FROM LPER WHERE LOANID=PROP_ALL.LOANID AND SecondPrecFYFinAsOfDate>=STATEMENTENDDATE_LOWER 
		AND SecondPrecFYFinAsOfDate<=STATEMENTENDDATE_UPPER) WHERE NUM_PROPS=1 AND LID_DD_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	LID_DD_REVFIELDNAME='SecondPrecedingFYRevenue',
	REV=(SELECT MAX(SecondPrecedingFYRevenue) FROM LPER WHERE LID_DD=LID_DD_REV AND SecondPrecedingFYRevenue>0),
	EXPENSE=(SELECT MAX(SecondPrecedingFYOpExp) FROM LPER WHERE LID_DD=LID_DD_REV AND SecondPrecedingFYOpExp>0),
	NOI=(SELECT MAX(SecondPrecedingFYNOI) FROM LPER WHERE LID_DD=LID_DD_REV AND SecondPrecedingFYNOI>0),
	NCF=(SELECT MAX(SecondPrecedingFYNCF) FROM LPER WHERE LID_DD=LID_DD_REV AND SecondPrecedingFYNCF>0),
	DEBTSERVICE=(SELECT MAX(SecondPrecFYDebtServAmt) FROM LPER WHERE LID_DD=LID_DD_REV AND SecondPrecFYDebtServAmt>0),
	OCCUP=(SELECT MAX(SecondPrecedingFYPhyOcc) FROM LPER WHERE LID_DD=LID_DD_REV AND SecondPrecedingFYPhyOcc>0),
	STATEMENTENDDATE_REV=(SELECT EOMONTH(DateDate) FROM DATECONVERT WHERE DateLong=(SELECT MAX(SecondPrecFYFinAsOfDate) FROM LPER WHERE LID_DD=LID_DD_REV))
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND LID_DD_REV IS NOT NULL

	---EXHIBITA,SECONDMOSTRECENTFINANCIALENDDATE,SECONDMOSTRECENTEGI
	UPDATE PROP_ALL SET EXA_PLID_REV=EXA_PLID WHERE (SELECT MAX(SECONDMOSTRECENTFINANCIALENDDATE) FROM EXHIBITA WHERE EXA_PLID=PROP_ALL.EXA_PLID)>=STATEMENTENDDATE_LOWER 
												AND (SELECT MAX(SECONDMOSTRECENTFINANCIALENDDATE) FROM EXHIBITA WHERE EXA_PLID=PROP_ALL.EXA_PLID)<=STATEMENTENDDATE_UPPER
												AND NUM_PROPS=1 AND EXA_PLID_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	EXA_PLID_REVFIELDNAME='SECONDMOSTRECENTEGI',
	REV=(SELECT MAX(SECONDMOSTRECENTEGI) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND SECONDMOSTRECENTEGI>0),
	EXPENSE=(SELECT MAX(SECONDMOSTRECENTEXPENSES) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND SECONDMOSTRECENTEXPENSES>0),
	NOI=(SELECT MAX(SECONDMOSTRECENTNOI) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND SECONDMOSTRECENTNOI>0),
	NCF=(SELECT MAX(SECONDMOSTRECENTNCF) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND SECONDMOSTRECENTNCF>0),
	--DEBTSERVICE=(SELECT SecondPrecFYDebtServAmt FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV),
	--OCCUP=(SELECT PHYSICALOCCUPANCYATCONTRIBUTION FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV),
	STATEMENTENDDATE_REV=(SELECT EOMONTH((SELECT DateDate FROM DATECONVERT WHERE DateLong=SECONDMOSTRECENTFINANCIALENDDATE)) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV)
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND EXA_PLID_REV IS NOT NULL

	---EXHIBITA,THIRDMOSTRECENTFINANCIALENDDATE,THIRDMOSTRECENTEGI
	UPDATE PROP_ALL SET EXA_PLID_REV=EXA_PLID WHERE (SELECT MAX(THIRDMOSTRECENTFINANCIALENDDATE) FROM EXHIBITA WHERE EXA_PLID=PROP_ALL.EXA_PLID)>=STATEMENTENDDATE_LOWER 
												AND (SELECT MAX(THIRDMOSTRECENTFINANCIALENDDATE) FROM EXHIBITA WHERE EXA_PLID=PROP_ALL.EXA_PLID)<=STATEMENTENDDATE_UPPER
												AND NUM_PROPS=1 AND  EXA_PLID_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	EXA_PLID_REVFIELDNAME='THIRDMOSTRECENTEGI',
	REV=(SELECT MAX(THIRDMOSTRECENTEGI) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND THIRDMOSTRECENTEGI>0),
	EXPENSE=(SELECT MAX(THIRDMOSTRECENTEXPENSES) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND THIRDMOSTRECENTEXPENSES>0),
	NOI=(SELECT MAX(THIRDMOSTRECENTNOI) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND THIRDMOSTRECENTNOI>0),
	NCF=(SELECT MAX(THIRDMOSTRECENTNCF) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND THIRDMOSTRECENTNCF>0),
	--DEBTSERVICE=(SELECT THIRDPrecFYDebtServAmt FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV),
	--OCCUP=(SELECT PHYSICALOCCUPANCYATCONTRIBUTION FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV),
	STATEMENTENDDATE_REV=(SELECT EOMONTH((SELECT DateDate FROM DATECONVERT WHERE DateLong=THIRDMOSTRECENTFINANCIALENDDATE)) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV)
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND EXA_PLID_REV IS NOT NULL

	---EXHIBITA,CONTRIBUTIONFINANCIALSASOFDATE,REVENUEATCONTRIBUTION
	UPDATE PROP_ALL SET EXA_PLID_REV=EXA_PLID WHERE (SELECT MAX(CONTRIBUTIONFINANCIALSASOFDATE) FROM EXHIBITA WHERE EXA_PLID=PROP_ALL.EXA_PLID)>=STATEMENTENDDATE_LOWER 
												AND (SELECT MAX(CONTRIBUTIONFINANCIALSASOFDATE) FROM EXHIBITA WHERE EXA_PLID=PROP_ALL.EXA_PLID)<=STATEMENTENDDATE_UPPER
												AND NUM_PROPS=1 AND EXA_PLID_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET
	HasREV=1,
	EXA_PLID_REVFIELDNAME='REVENUEATCONTRIBUTION',
	REV=(SELECT MAX(REVENUEATCONTRIBUTION) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND REVENUEATCONTRIBUTION>0),
	EXPENSE=(SELECT MAX(OPERATINGEXPENSESATCONTRIBUTION) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND OPERATINGEXPENSESATCONTRIBUTION>0),
	NOI=(SELECT MAX(NOIATCONTRIBUTION) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND NOIATCONTRIBUTION>0),
	NCF=(SELECT MAX(NCFATCONTRIBUTION) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND NCFATCONTRIBUTION>0),
	--DEBTSERVICE=(SELECT SecondPrecFYDebtServAmt) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND XXXX>0),
	OCCUP=(SELECT MAX(PHYSICALOCCUPANCYATCONTRIBUTION) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV AND PHYSICALOCCUPANCYATCONTRIBUTION>0),
	STATEMENTENDDATE_REV=(SELECT EOMONTH((SELECT DateDate FROM DATECONVERT WHERE DateLong=CONTRIBUTIONFINANCIALSASOFDATE)) FROM EXHIBITA WHERE EXA_PLID=EXA_PLID_REV)
	WHERE HasREV=0 AND STATEMENTYEAR=@YEAR AND EXA_PLID_REV IS NOT NULL

	UPDATE PROP_ALL SET STATEMENTBEGDATE_REV=DATEADD(M,-12,STATEMENTENDDATE_REV) WHERE HASREV=1 AND STATEMENTBEGDATE_REV IS NULL AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET NUMDAYS_REV=DATEDIFF(D,STATEMENTBEGDATE_REV,STATEMENTENDDATE_REV) WHERE HASREV=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	HasREV=0,
	LID_PID_DD_REV=NULL,
	LID_DD_REV=NULL,
	EXA_PLID_REV=NULL,
	REV=NULL,
	EXPENSE=NULL,
	NOI=NULL,
	NCF=NULL,
	STATEMENTBEGDATE_REV=NULL,
	STATEMENTENDDATE_REV=NULL,
	NUMDAYS_REV=NULL
	WHERE (NUMDAYS_REV IS NULL OR NUMDAYS_REV<330 OR NUMDAYS_REV>390) AND STATEMENTYEAR=@YEAR

	--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	SELECT CONCAT('PROP_ALL CALC UW,ORIG,EVENTS,REV END - BEFORE FF/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	--SELECT * FROM PROP_ALL WHERE STATEMENTYEAR=@YEAR ORDER BY UWDATE DESC


	--FF,StatementEndDate,StatementBegDate,GROSRNT
	UPDATE PROP_ALL SET HasFF=0 WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LID_PID_SB_SE_DT_ST=NULL WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LID_PID_SB_SE_DT_ST=(SELECT MAX(LID_PID_SB_SE_DT_ST) FROM FF WHERE 
		LOANID=PROP_ALL.LOANID AND PropertyID=PROP_ALL.PropertyID
		AND StatementEndDate>=STATEMENTENDDATE_LOWER AND StatementEndDate<=STATEMENTENDDATE_UPPER
		--AND StatementBegDate>=STATEMENTBEGDATE_LOWER AND StatementBEGDate<=STATEMENTBEGDATE_UPPER
		AND StmtType='NOR' AND DataType='AN') 
		WHERE STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET HasFF=1 WHERE LID_PID_SB_SE_DT_ST IS NOT NULL AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET STATEMENTBEGDATE_FF=(SELECT DateDate FROM DATECONVERT WHERE DateLong=(SELECT MAX(StatementBegDate) FROM FF WHERE LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST)) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET STATEMENTENDDATE_FF=(SELECT DateDate FROM DATECONVERT WHERE DateLong=(SELECT MAX(StatementEndDate) FROM FF WHERE LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST)) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET NUMDAYS_FF=DATEDIFF(D,STATEMENTBEGDATE_FF,STATEMENTENDDATE_FF) WHERE HasFF=1 AND STATEMENTYEAR=@YEAR

	--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	SELECT CONCAT('PROP_ALL FF DATES CALCS/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	--SELECT * FROM PROP_ALL WHERE STATEMENTYEAR=@YEAR ORDER BY UWDATE DESC

	UPDATE PROP_ALL SET 
	HasFF=0,
	LID_PID_SB_SE_DT_ST=NULL,
	STATEMENTBEGDATE_FF=NULL, 
	STATEMENTENDDATE_FF=NULL,
	NUMDAYS_FF=NULL
	WHERE (NUMDAYS_FF IS NULL OR NUMDAYS_FF<330 OR NUMDAYS_FF>390)  AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET GROSRNT=(SELECT MAX(AMOUNT) FROM FF WHERE CATEGORYCODE='010GROSRNT' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET VACANCY=(SELECT MAX(AMOUNT) FROM FF WHERE CATEGORYCODE='020VACANCY' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET BASERNT=(SELECT MAX(AMOUNT) FROM FF WHERE CATEGORYCODE='030BASERNT' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET HC_INC_PVTPAY=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='100PVTPAY' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET HC_INC_MEDCARE=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='110MEDCARE' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET HC_INC_NURSING=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='120NURSING' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET HC_INC_MEALS=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='130MEALS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET LAUNDRY=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='140LAUNDRY' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET PARKING=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='150PARKING' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET OTHERIN=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='160OTHERIN' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1

	UPDATE PROP_ALL SET RETAXES=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='310RETAXES' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET PROPINS=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='320PROPINS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET UTILITI=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='330UTILITI' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET REPAIRS=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='340REPAIRS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET MANAGEM=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='370MANAGEM' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET PAYROLL=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='380PAYROLL' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET MARKETI=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='390MARKETI' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET PROFESS=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='400PROFESS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET GENERAL=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='410GENERAL' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET HC_EXP_ROOMS=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='420ROOMS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET HC_EXP_MEALS=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='430MEALS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET OTHEREX=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='440OTHEREX' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET GROUNDR=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='450GROUNDR' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET CAPEX=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='510CAPEX' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET EXCAPEX=(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='520EXCAPEX' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST) WHERE STATEMENTYEAR=@YEAR AND HasFF=1

	UPDATE PROP_ALL SET BASERNT=NULL WHERE GROSRNT>0 AND STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET GROSRNT=NULL WHERE BASERNT>0 AND STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET VACANCY=NULL WHERE BASERNT>0 AND STATEMENTYEAR=@YEAR AND HasFF=1
	UPDATE PROP_ALL SET VACANCY=0 WHERE VACANCY IS NULL AND STATEMENTYEAR=@YEAR AND GROSRNT>0 AND HasFF=1
	UPDATE PROP_ALL SET GROSRNT=0 WHERE GROSRNT IS NULL AND STATEMENTYEAR=@YEAR AND VACANCY>0 AND HasFF=1

	UPDATE PROP_ALL SET HasFF=0 WHERE
	(GROSRNT IS NULL OR GROSRNT=0)
	AND (VACANCY IS NULL OR VACANCY=0)
	AND (BASERNT IS NULL OR BASERNT=0)
	AND (HC_INC_PVTPAY IS NULL OR HC_INC_PVTPAY=0)
	AND (HC_INC_MEDCARE IS NULL OR HC_INC_MEDCARE=0)
	AND (HC_INC_NURSING IS NULL OR HC_INC_NURSING=0)
	AND (HC_INC_MEALS IS NULL OR HC_INC_MEALS=0)
	AND (LAUNDRY IS NULL OR LAUNDRY=0)
	AND (PARKING IS NULL OR PARKING=0)
	AND (OTHERIN IS NULL OR OTHERIN=0)
	AND STATEMENTYEAR=@YEAR 

	UPDATE PROP_ALL SET HasFF=0 WHERE
	(RETAXES IS NULL OR RETAXES=0)
	AND (PROPINS IS NULL OR PROPINS=0)
	AND (UTILITI IS NULL OR UTILITI=0)
	AND (REPAIRS IS NULL OR REPAIRS=0)
	AND (MANAGEM IS NULL OR MANAGEM=0)
	AND (PAYROLL IS NULL OR PAYROLL=0)
	AND (MARKETI IS NULL OR MARKETI=0)
	AND (PROFESS IS NULL OR PROFESS=0)
	AND (GENERAL IS NULL OR GENERAL=0)
	AND (HC_EXP_ROOMS IS NULL OR HC_EXP_ROOMS=0)
	AND (HC_EXP_MEALS IS NULL OR HC_EXP_MEALS=0)
	AND (OTHEREX IS NULL OR OTHEREX=0)
	AND (GROUNDR IS NULL OR GROUNDR=0)
	AND (CAPEX IS NULL OR CAPEX=0)
	AND (EXCAPEX IS NULL  OR EXCAPEX=0)
	AND STATEMENTYEAR=@YEAR 

	UPDATE PROP_ALL SET HC_INC_PVTPAY=0 WHERE HC_INC_PVTPAY IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET HC_INC_MEDCARE=0 WHERE HC_INC_MEDCARE IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET HC_INC_NURSING=0 WHERE HC_INC_NURSING IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET HC_INC_MEALS=0 WHERE HC_INC_MEALS IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET LAUNDRY=0 WHERE LAUNDRY IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET PARKING=0 WHERE PARKING IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET OTHERIN=0 WHERE OTHERIN IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET RETAXES=0 WHERE RETAXES IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET PROPINS=0 WHERE PROPINS IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET UTILITI=0 WHERE UTILITI IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REPAIRS=0 WHERE REPAIRS IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET MANAGEM=0 WHERE MANAGEM IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET PAYROLL=0 WHERE PAYROLL IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET MARKETI=0 WHERE MARKETI IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET PROFESS=0 WHERE PROFESS IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET GENERAL=0 WHERE GENERAL IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET HC_EXP_ROOMS=0 WHERE HC_EXP_ROOMS IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET HC_EXP_MEALS=0 WHERE HC_EXP_MEALS IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET OTHEREX=0 WHERE OTHEREX IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET GROUNDR=0 WHERE GROUNDR IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET CAPEX=0 WHERE CAPEX IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXCAPEX=0 WHERE EXCAPEX IS NULL AND HasFF=1 AND STATEMENTYEAR=@YEAR

	--MATCH HASREV=HASFF WHERE HASFF=1
	UPDATE PROP_ALL SET
	HasREV=1,
	STATEMENTBEGDATE_REV=STATEMENTBEGDATE_FF,
	STATEMENTENDDATE_REV=STATEMENTENDDATE_FF,
	NUMDAYS_REV=NUMDAYS_FF
	WHERE HASFF=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET REV=0 WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+GROSRNT WHERE GROSRNT IS NOT NULL AND HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+VACANCY WHERE VACANCY IS NOT NULL AND HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+BASERNT WHERE BASERNT IS NOT NULL AND HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+LAUNDRY WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+PARKING WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+OTHERIN WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+HC_INC_PVTPAY WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+HC_INC_MEDCARE WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+HC_INC_NURSING WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET REV=REV+HC_INC_MEALS WHERE HASFF=1 AND STATEMENTYEAR=@YEAR


	UPDATE PROP_ALL SET EXPENSE=0 WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+RETAXES WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+PROPINS WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+UTILITI WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+REPAIRS WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+MANAGEM WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+PAYROLL WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+MARKETI WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+PROFESS WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+GENERAL WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+OTHEREX WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+GROUNDR WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+HC_EXP_ROOMS WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXPENSE=EXPENSE+HC_EXP_MEALS WHERE HASFF=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET NOI=REV-EXPENSE WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET NCF=NOI WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET NCF=NCF-CAPEX WHERE HASFF=1 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET NCF=NCF-EXCAPEX WHERE HASFF=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET CAPEX=0 WHERE CAPEX<0 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXCAPEX=0 WHERE EXCAPEX<0 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET NCF=NOI WHERE NCF>NOI AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET CAPEX=0 WHERE CAPEX<0 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET EXCAPEX=0 WHERE EXCAPEX<0 AND STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET NCF=NOI WHERE NCF>NOI AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET HasFF=0 WHERE
	(GROSRNT IS NULL OR GROSRNT=0)
	AND (VACANCY IS NULL OR VACANCY=0)
	AND (BASERNT IS NULL OR BASERNT=0)
	AND (HC_INC_PVTPAY IS NULL OR HC_INC_PVTPAY=0)
	AND (HC_INC_MEDCARE IS NULL OR HC_INC_MEDCARE=0)
	AND (HC_INC_NURSING IS NULL OR HC_INC_NURSING=0)
	AND (HC_INC_MEALS IS NULL OR HC_INC_MEALS=0)
	AND (LAUNDRY IS NULL OR LAUNDRY=0)
	AND (PARKING IS NULL OR PARKING=0)
	AND (OTHERIN IS NULL OR OTHERIN=0)
	AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET HasFF=0 WHERE
	(RETAXES IS NULL OR RETAXES=0)
	AND (PROPINS IS NULL OR PROPINS=0)
	AND (UTILITI IS NULL OR UTILITI=0)
	AND (REPAIRS IS NULL OR REPAIRS=0)
	AND (MANAGEM IS NULL OR MANAGEM=0)
	AND (PAYROLL IS NULL OR PAYROLL=0)
	AND (MARKETI IS NULL OR MARKETI=0)
	AND (PROFESS IS NULL OR PROFESS=0)
	AND (GENERAL IS NULL OR GENERAL=0)
	AND (HC_EXP_ROOMS IS NULL OR HC_EXP_ROOMS=0)
	AND (HC_EXP_MEALS IS NULL OR HC_EXP_MEALS=0)
	AND (OTHEREX IS NULL OR OTHEREX=0)
	AND (GROUNDR IS NULL OR GROUNDR=0)
	AND (CAPEX IS NULL OR CAPEX=0)
	AND (EXCAPEX IS NULL  OR EXCAPEX=0)
	AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET
	LID_PID_DD_REV=NULL,
	LID_DD_REV=NULL,
	EXA_PLID_REV=NULL,
	STATEMENTBEGDATE_REV=NULL,
	STATEMENTENDDATE_REV=NULL,
	NUMDAYS_REV=NULL,
	REV=NULL,
	EXPENSE=NULL,
	NOI=NULL,
	NCF=NULL
	WHERE HASREV=0 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET
	HasFF=0,
	LID_PID_SB_SE_DT_ST=NULL,
	STATEMENTBEGDATE_FF=NULL, 
	STATEMENTENDDATE_FF=NULL,
	NUMDAYS_FF=NULL,
	GROSRNT=NULL,
	VACANCY=NULL,
	BASERNT=NULL,
	HC_INC_PVTPAY=NULL,
	HC_INC_MEDCARE=NULL,
	HC_INC_NURSING=NULL,
	HC_INC_MEALS=NULL,
	LAUNDRY=NULL,
	PARKING=NULL,
	OTHERIN=NULL,
	RETAXES=NULL,
	PROPINS=NULL,
	UTILITI=NULL,
	REPAIRS=NULL,
	MANAGEM=NULL,
	PAYROLL=NULL,
	MARKETI=NULL,
	PROFESS=NULL,
	GENERAL=NULL,
	HC_EXP_ROOMS=NULL,
	HC_EXP_MEALS=NULL,
	OTHEREX=NULL,
	GROUNDR=NULL,
	CAPEX=NULL,
	EXCAPEX=NULL
	WHERE HASFF=0 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET 
	STATEMENTBEGDATE=STATEMENTBEGDATE_REV,
	STATEMENTENDDATE=STATEMENTENDDATE_REV,
	NUMDAYS=NUMDAYS_REV
	WHERE HASREV=1 AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET
	REV=(364.25/NUMDAYS_REV)*REV,
	EXPENSE=(364.25/NUMDAYS_REV)*EXPENSE,
	NOI=(364.25/NUMDAYS_REV)*NOI,
	NCF=(364.25/NUMDAYS_REV)*NCF
	WHERE HasREV=1 AND (NUMDAYS_REV<360 OR NUMDAYS_REV>370) AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET
	GROSRNT=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE CATEGORYCODE='010GROSRNT' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	VACANCY=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE CATEGORYCODE='020VACANCY' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	BASERNT=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE CATEGORYCODE='030BASERNT' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	HC_INC_PVTPAY=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='100PVTPAY' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	HC_INC_MEDCARE=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='110MEDCARE' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	HC_INC_NURSING=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='120NURSING' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	HC_INC_MEALS=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='130MEALS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	LAUNDRY=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='140LAUNDRY' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	PARKING=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='150PARKING' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	OTHERIN=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='160OTHERIN' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),

	RETAXES=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='310RETAXES' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	PROPINS=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='320PROPINS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	UTILITI=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='330UTILITI' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	REPAIRS=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='340REPAIRS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	MANAGEM=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='370MANAGEM' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	PAYROLL=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='380PAYROLL' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	MARKETI=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='390MARKETI' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	PROFESS=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='400PROFESS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	GENERAL=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='410GENERAL' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	HC_EXP_ROOMS=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='420ROOMS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	HC_EXP_MEALS=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='430MEALS' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	OTHEREX=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='440OTHEREX' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	GROUNDR=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='450GROUNDR' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	CAPEX=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='510CAPEX' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST),
	EXCAPEX=(364.25/NUMDAYS_FF)*(SELECT MAX(AMOUNT) FROM FF WHERE  CATEGORYCODE='520EXCAPEX' AND LID_PID_SB_SE_DT_ST=PROP_ALL.LID_PID_SB_SE_DT_ST)
	WHERE HasFF=1 AND (NUMDAYS_FF<360 OR NUMDAYS_FF>370) AND STATEMENTYEAR=@YEAR

	UPDATE PROP_ALL SET HasDATA=0 WHERE STATEMENTYEAR=@YEAR
	UPDATE PROP_ALL SET HasDATA=1 WHERE
	(HasVAL=1 OR HasORIG=1 OR HasUW=1 OR HasREV=1 OR HasEVENT=1 OR HasFF=1)
	AND STATEMENTYEAR=@YEAR

	--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	SELECT CONCAT('STEP#13:PROP_ALL COMPLETE/',@YEAR,'/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
	--SELECT * FROM PROP_ALL WHERE STATEMENTYEAR=@YEAR ORDER BY UWDATE DESC
	SELECT @YEAR=@YEAR-1
END

EXECUTE INSERT_PROP_DEMOGRAPHIC_SCORE_ALL 2020
--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
SELECT CONCAT('PROP_DEMOGRAPHIC_SCORE/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
--SELECT * FROM PROP_DEMOGRAPHIC_SCORE ORDER BY EXID_PLID_PRID DESC

TRUNCATE TABLE PROP_DISTINCT_CALCS
INSERT INTO PROP_DISTINCT_CALCS
(EXID_PLID_PRID_YR,
METRO_SUBTYPE_YR,
DIVISION_SUBTYPE_YR,
REGION_SUBTYPE_YR,
ALLUS_SUBTYPE_YR,
CALC_NARRATIVE,
EXID_PLID_PRID,
STATEMENTYEAR,
EXATRANSACTIONID,
PROSPECTUSLOANID,
SAMEGEO,
SAMEPROPERTYID,
LOANID,
PROPERTYID,
EXA_PLID,

PROPERTYNAME,
PROPERTYADDRESS,
PROPERTYCITY,
PROPERTYSTATE,
PROPERTYZIPCODE,
PROPERTYCOUNTY,
NCREIFRegion,
NCREIFDivision,
NCREIFMetro,
Latitude,
Longitude,
YearBuilt,
YearRenov,
YearBuiltRenov,
NumUnits,
PropertySubType,
PropertySubType_ASSIGNED,
HasData,
EstData,
HasORIG,
HasEvent,
HasVAL,
HasUW,
HasREV,
HasFF,
--EstREV,
--EstFF,
--AdjREV,
--AdjFF,
STATEMENTBEGDATE,
STATEMENTENDDATE,
NUMDAYS,
STATEMENTBEGDATE_REV,
STATEMENTENDDATE_REV,
NUMDAYS_REV,
STATEMENTBEGDATE_FF,
STATEMENTENDDATE_FF,
NUMDAYS_FF,
EXID_PLID_PRID_ORIG,
EXA_PLID_ORIG,
LID_DD_ORIG,
LOANORIGINATOR,
LOANORIGBALANCE,
LOANORIGDATE,
LOANFIXEDVSFLOAT,
LOANORIGTERM,
LOANPURPOSE,
LOANORIGLTV,
LOANPREPAYMENT,
LOANASSUMPTION,
LOANWATCHLIST,
LOANTRANSFERTOSPECIAL,
LOANMODIFICATION,
LOANLIQUIDATION,
LOANDQ,
LOANPREPAYMENT_M,
LOANASSUMPTION_M,
LOANWATCHLIST_M,
LOANTRANSFERTOSPECIAL_M,
LOANMODIFICATION_M,
LOANLIQUIDATION_M,
LOANDQ_M,

EXA_PLID_VAL,
LID_DD_VAL,
LID_PRID_DD_VAL,
EXA_PLID_VALFIELDNAME,
LID_PRID_DD_VALFIELDNAME,
LID_DD_VALFIELDNAME,
VALUATIONAMOUNT,
VALUATIONDATE,

EXID_PLID_PRID_UW,
EXA_PLID_UW,
UWDATE,
VAL_UW,
REV_UW,
EXP_UW,
NOI_UW,
NCF_UW,
UW_REV_ACTUAL_RATIO,
UW_EXP_ACTUAL_RATIO,
UW_NOI_ACTUAL_RATIO,
DEBTSERVICE_IO_UW,
DEBTSERVICE_AMORT_UW,
DEBTSERVICE_CAP_UW,
EXA_PLID_REV,
LID_PID_DD_REV,
LID_DD_REV,
EXA_PLID_REVFIELDNAME,
LID_PID_DD_REVFIELDNAME,
LID_DD_REVFIELDNAME,
ADJ_REV,
ADJ_EXP,
REV,
EXPENSE,
NOI,
NCF,
DEBTSERVICE,
OCCUP,
LID_PID_SB_SE_DT_ST,
GROSRNT,
VACANCY,
BASERNT,
LAUNDRY,
PARKING,
OTHERIN,
RETAXES,
PROPINS,
UTILITI,
REPAIRS,
MANAGEM,
PAYROLL,
MARKETI,
PROFESS,
GENERAL,
OTHEREX,
GROUNDR,
CAPEX,
EXCAPEX,
HC_INC_PVTPAY,
HC_INC_MEDCARE,
HC_INC_NURSING,
HC_INC_MEALS,
HC_EXP_ROOMS,
HC_EXP_MEALS)

SELECT 
EXID_PLID_PRID_YR,
CONCAT(NCREIFMETRO,'_',PROPERTYSUBTYPE_ASSIGNED,'_',STATEMENTYEAR),
CONCAT(NCREIFDIVISION,'_',PROPERTYSUBTYPE_ASSIGNED,'_',STATEMENTYEAR),
CONCAT(NCREIFREGION,'_',PROPERTYSUBTYPE_ASSIGNED,'_',STATEMENTYEAR),
CONCAT('ALLUS','_',PROPERTYSUBTYPE_ASSIGNED,'_',STATEMENTYEAR),
CALC_NARRATIVE,
EXID_PLID_PRID,
STATEMENTYEAR,
EXATRANSACTIONID,
PROSPECTUSLOANID,
SAMEGEO,
SAMEPROPERTYID,
LOANID,
PROPERTYID,
EXA_PLID,

PROPERTYNAME,
PROPERTYADDRESS,
PROPERTYCITY,
PROPERTYSTATE,
PROPERTYZIPCODE,
PROPERTYCOUNTY,
NCREIFRegion,
NCREIFDivision,
NCREIFMetro,
Latitude,
Longitude,
YearBuilt,
YearRenov,
YearBuiltRenov,
NumUnits,
PropertySubType,
PropertySubType_ASSIGNED,
HasData,
EstData,
HasORIG,
HasEvent,
HasVAL,
HasUW,
HasREV,
HasFF,
--EstREV,
--EstFF,
--AdjREV,
--AdjFF,
STATEMENTBEGDATE,
STATEMENTENDDATE,
NUMDAYS,
STATEMENTBEGDATE_REV,
STATEMENTENDDATE_REV,
NUMDAYS_REV,
STATEMENTBEGDATE_FF,
STATEMENTENDDATE_FF,
NUMDAYS_FF,
EXID_PLID_PRID_ORIG,
EXA_PLID_ORIG,
LID_DD_ORIG,
LOANORIGINATOR,
LOANORIGBALANCE,
LOANORIGDATE,
LOANFIXEDVSFLOAT,
LOANORIGTERM,
LOANPURPOSE,
LOANORIGLTV,
LOANPREPAYMENT,
LOANASSUMPTION,
LOANWATCHLIST,
LOANTRANSFERTOSPECIAL,
LOANMODIFICATION,
LOANLIQUIDATION,
LOANDQ,
LOANPREPAYMENT_M,
LOANASSUMPTION_M,
LOANWATCHLIST_M,
LOANTRANSFERTOSPECIAL_M,
LOANMODIFICATION_M,
LOANLIQUIDATION_M,
LOANDQ_M,

EXA_PLID_VAL,
LID_DD_VAL,
LID_PRID_DD_VAL,
EXA_PLID_VALFIELDNAME,
LID_PRID_DD_VALFIELDNAME,
LID_DD_VALFIELDNAME,
VALUATIONAMOUNT,
VALUATIONDATE,

EXID_PLID_PRID_UW,
EXA_PLID_UW,
UWDATE,
VAL_UW,
REV_UW,
EXP_UW,
NOI_UW,
NCF_UW,
UW_REV_ACTUAL_RATIO,
UW_EXP_ACTUAL_RATIO,
UW_NOI_ACTUAL_RATIO,
DEBTSERVICE_IO_UW,
DEBTSERVICE_AMORT_UW,
DEBTSERVICE_CAP_UW,
EXA_PLID_REV,
LID_PID_DD_REV,
LID_DD_REV,
EXA_PLID_REVFIELDNAME,
LID_PID_DD_REVFIELDNAME,
LID_DD_REVFIELDNAME,
ADJ_REV,
ADJ_EXP,
REV,
EXPENSE,
NOI,
NCF,
DEBTSERVICE,
OCCUP,
LID_PID_SB_SE_DT_ST,
GROSRNT,
VACANCY,
BASERNT,
LAUNDRY,
PARKING,
OTHERIN,
RETAXES,
PROPINS,
UTILITI,
REPAIRS,
MANAGEM,
PAYROLL,
MARKETI,
PROFESS,
GENERAL,
OTHEREX,
GROUNDR,
CAPEX,
EXCAPEX,
HC_INC_PVTPAY,
HC_INC_MEDCARE,
HC_INC_NURSING,
HC_INC_MEALS,
HC_EXP_ROOMS,
HC_EXP_MEALS

FROM PROP_ALL WHERE SAMEGEO IS NOT NULL AND SAMEPROPERTYID IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET COUNTSAMEPROPERTY=(SELECT COUNT(DISTINCT P.EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID)
UPDATE PROP_DISTINCT_CALCS SET RECENTVALUATIONDATE=(SELECT MIN(P.ValuationDate) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID) WHERE COUNTSAMEPROPERTY>1
UPDATE PROP_DISTINCT_CALCS SET EXID_PLID_PRID_KEEPER=(SELECT MAX(P.EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID 
				AND P.ValuationDate<DATEADD(D,1,RECENTVALUATIONDATE)) WHERE EXID_PLID_PRID_KEEPER IS NULL AND COUNTSAMEPROPERTY>1
UPDATE PROP_DISTINCT_CALCS SET EXID_PLID_PRID_KEEPER=(SELECT MAX(P.EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID) WHERE COUNTSAMEPROPERTY>1

--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
SELECT CONCAT('PROP_DISTINCT_CALCS INSERTED/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
--SELECT * FROM PROP_DISTINCT_CALCS ORDER BY UWDATE DESC

DELETE FROM PROP_DISTINCT_CALCS WHERE COUNTSAMEPROPERTY=1 AND HASDATA=0
DELETE FROM PROP_DISTINCT_CALCS WHERE COUNTSAMEPROPERTY>1 
		AND (SELECT COUNT(*) FROM PROP_DISTINCT_CALCS X WHERE X.HASDATA=1 AND X.EXID_PLID_PRID_KEEPER=PROP_DISTINCT_CALCS.EXID_PLID_PRID_KEEPER AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)=0

--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
SELECT CONCAT('PROP_DISTINCT_CALCS DELETE NON-UNIQUE/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
--SELECT * FROM PROP_DISTINCT_CALCS ORDER BY UWDATE DESC


UPDATE PROP_DISTINCT_CALCS SET 
EXID_PLID_PRID_VAL=(SELECT MAX(EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID AND P.HasVAL=1 AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXID_PLID_PRID_UW=(SELECT MAX(EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID AND P.HasUW=1 AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXID_PLID_PRID_ORIG=(SELECT MAX(EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID AND P.HasORIG=1 AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXID_PLID_PRID_REV=(SELECT MAX(EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID AND P.HasREV=1 AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXID_PLID_PRID_FF=(SELECT MAX(EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID AND P.HasFF=1 AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXID_PLID_PRID_LOANEVENT=(SELECT MAX(EXID_PLID_PRID) FROM PROP_ALL P WHERE P.SAMEPROPERTYID=PROP_DISTINCT_CALCS.SAMEPROPERTYID AND P.HasEVENT=1 AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)
WHERE COUNTSAMEPROPERTY>1


UPDATE PROP_DISTINCT_CALCS SET
HASVAL=(SELECT HASVAL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXA_PLID_VAL=(SELECT EXA_PLID_VAL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_DD_VAL=(SELECT LID_DD_VAL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_PRID_DD_VAL=(SELECT LID_PRID_DD_VAL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXA_PLID_VALFIELDNAME=(SELECT EXA_PLID_VALFIELDNAME FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_PRID_DD_VALFIELDNAME=(SELECT LID_PRID_DD_VALFIELDNAME FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_DD_VALFIELDNAME=(SELECT LID_DD_VALFIELDNAME FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
VALUATIONAMOUNT=(SELECT VALUATIONAMOUNT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
VALUATIONDATE=(SELECT VALUATIONDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_VAL AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)
WHERE EXID_PLID_PRID=EXID_PLID_PRID_KEEPER AND EXID_PLID_PRID_VAL IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET
HASUW=(SELECT HASUW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXA_PLID_UW=(SELECT EXA_PLID_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
UWDATE=(SELECT UWDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
VAL_UW=(SELECT VAL_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
REV_UW=(SELECT REV_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXP_UW=(SELECT EXP_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NOI_UW=(SELECT NOI_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
UW_NOI_ACTUAL_RATIO=(SELECT UW_NOI_ACTUAL_RATIO FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NCF_UW=(SELECT NCF_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
DEBTSERVICE_IO_UW=(SELECT DEBTSERVICE_IO_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
DEBTSERVICE_AMORT_UW=(SELECT DEBTSERVICE_AMORT_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
DEBTSERVICE_CAP_UW=(SELECT DEBTSERVICE_CAP_UW FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_UW AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)
WHERE EXID_PLID_PRID=EXID_PLID_PRID_KEEPER AND EXID_PLID_PRID_UW IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET
HASORIG=(SELECT HASORIG FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
EXA_PLID_ORIG=(SELECT EXA_PLID_ORIG FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LID_DD_ORIG=(SELECT LID_DD_ORIG FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANORIGINATOR=(SELECT LOANORIGINATOR FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANORIGBALANCE=(SELECT LOANORIGBALANCE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANORIGDATE=(SELECT LOANORIGDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANFIXEDVSFLOAT=(SELECT LOANFIXEDVSFLOAT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANORIGTERM=(SELECT LOANORIGTERM FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANPURPOSE=(SELECT LOANPURPOSE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR), 
LOANORIGLTV=(SELECT LOANORIGLTV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_ORIG AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)
WHERE EXID_PLID_PRID=EXID_PLID_PRID_KEEPER AND EXID_PLID_PRID_ORIG IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET
HASREV=(SELECT HASREV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
STATEMENTBEGDATE=(SELECT STATEMENTBEGDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
STATEMENTENDDATE=(SELECT STATEMENTENDDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NUMDAYS=(SELECT NUMDAYS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
STATEMENTBEGDATE_REV=(SELECT STATEMENTBEGDATE_REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
STATEMENTENDDATE_REV=(SELECT STATEMENTENDDATE_REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NUMDAYS_REV=(SELECT NUMDAYS_REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXA_PLID_REV=(SELECT EXA_PLID_REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_PID_DD_REV=(SELECT LID_PID_DD_REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_DD_REV=(SELECT LID_DD_REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXA_PLID_REVFIELDNAME=(SELECT EXA_PLID_REVFIELDNAME FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_PID_DD_REVFIELDNAME=(SELECT LID_PID_DD_REVFIELDNAME FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_DD_REVFIELDNAME=(SELECT LID_DD_REVFIELDNAME FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
REV=(SELECT REV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXPENSE=(SELECT EXPENSE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NOI=(SELECT NOI FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NCF=(SELECT NCF FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
DEBTSERVICE=(SELECT DEBTSERVICE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
OCCUP=(SELECT OCCUP FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_REV AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)
WHERE EXID_PLID_PRID=EXID_PLID_PRID_KEEPER AND EXID_PLID_PRID_REV IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET
HASFF=(SELECT  HASFF FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LID_PID_SB_SE_DT_ST=(SELECT  LID_PID_SB_SE_DT_ST FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
STATEMENTBEGDATE_FF=(SELECT  STATEMENTBEGDATE_FF FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
STATEMENTENDDATE_FF=(SELECT  STATEMENTENDDATE_FF FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
NUMDAYS_FF=(SELECT  NUMDAYS_FF FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
GROSRNT=(SELECT  GROSRNT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
VACANCY=(SELECT  VACANCY FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
BASERNT=(SELECT  BASERNT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LAUNDRY=(SELECT  LAUNDRY FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
PARKING=(SELECT  PARKING FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
OTHERIN=(SELECT  OTHERIN FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
RETAXES=(SELECT  RETAXES FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
PROPINS=(SELECT  PROPINS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
UTILITI=(SELECT  UTILITI FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
REPAIRS=(SELECT  REPAIRS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
MANAGEM=(SELECT  MANAGEM FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
PAYROLL=(SELECT  PAYROLL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
MARKETI=(SELECT  MARKETI FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
PROFESS=(SELECT  PROFESS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
GENERAL=(SELECT  GENERAL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
OTHEREX=(SELECT  OTHEREX FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
GROUNDR=(SELECT  GROUNDR FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
CAPEX=(SELECT  CAPEX FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
EXCAPEX=(SELECT  EXCAPEX FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
HC_INC_PVTPAY=(SELECT  HC_INC_PVTPAY FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
HC_INC_MEDCARE=(SELECT  HC_INC_MEDCARE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
HC_INC_NURSING=(SELECT  HC_INC_NURSING FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
HC_INC_MEALS=(SELECT  HC_INC_MEALS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
HC_EXP_ROOMS=(SELECT  HC_EXP_ROOMS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
HC_EXP_MEALS=(SELECT  HC_EXP_MEALS FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_FF AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)

WHERE EXID_PLID_PRID=EXID_PLID_PRID_KEEPER AND EXID_PLID_PRID_FF IS NOT NULL


UPDATE PROP_DISTINCT_CALCS SET
LOANPREPAYMENT=(SELECT  LOANPREPAYMENT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANASSUMPTION=(SELECT  LOANASSUMPTION FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANWATCHLIST=(SELECT  LOANWATCHLIST FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANTRANSFERTOSPECIAL=(SELECT  LOANTRANSFERTOSPECIAL FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANMODIFICATION=(SELECT  LOANMODIFICATION FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANLIQUIDATION=(SELECT  LOANLIQUIDATION FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANDQ=(SELECT  LOANDQ FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANPREPAYMENT_M=(SELECT  LOANPREPAYMENT_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANASSUMPTION_M=(SELECT  LOANASSUMPTION_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANWATCHLIST_M=(SELECT  LOANWATCHLIST_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANTRANSFERTOSPECIAL_M=(SELECT  LOANTRANSFERTOSPECIAL_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANMODIFICATION_M=(SELECT  LOANMODIFICATION_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANLIQUIDATION_M=(SELECT  LOANLIQUIDATION_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANDQ_M=(SELECT  LOANDQ_M FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),

VALUATIONAMOUNT_EVENT=(SELECT  VALUATIONAMOUNT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
VALUATIONDATE_EVENT=(SELECT  VALUATIONDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANORIGINATOR_EVENT=(SELECT  LOANORIGINATOR FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANORIGBALANCE_EVENT=(SELECT  LOANORIGBALANCE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANORIGDATE_EVENT=(SELECT  LOANORIGDATE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANFIXEDVSFLOAT_EVENT=(SELECT  LOANFIXEDVSFLOAT FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANORIGTERM_EVENT=(SELECT  LOANORIGTERM FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANPURPOSE_EVENT=(SELECT  LOANPURPOSE FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR),
LOANORIGLTV_EVENT=(SELECT  LOANORIGLTV FROM PROP_ALL P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID_LOANEVENT AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR)

WHERE EXID_PLID_PRID=EXID_PLID_PRID_KEEPER AND EXID_PLID_PRID_LOANEVENT IS NOT NULL

--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
SELECT CONCAT('PROP_DISTINCT_CALCS ... ASSIGN DATA TO UNIQUE EXID_PLID_PRID/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
--SELECT * FROM PROP_DISTINCT_CALCS ORDER BY UWDATE DESC

DELETE FROM PROP_DISTINCT_CALCS WHERE COUNTSAMEPROPERTY>1 AND EXID_PLID_PRID<>EXID_PLID_PRID_KEEPER
UPDATE PROP_DISTINCT_CALCS SET HASDATA=0
UPDATE PROP_DISTINCT_CALCS SET HasDATA=1 WHERE
(HasVAL=1 OR HasORIG=1 OR HasUW=1 OR HasREV=1 OR HasEVENT=1 OR HasFF=1)
DELETE FROM PROP_DISTINCT_CALCS WHERE HASDATA=0

--DECLARE @TIMESTAMP_LAST DATETIME2(7) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
SELECT CONCAT('PROP_DISTINCT_CALCS ... DELETE THE NON-UNIQUE/RUNTIME(SEC)=', DATEDIFF(S,@TIMESTAMP_LAST,CURRENT_TIMESTAMP)) SELECT @TIMESTAMP_LAST=CURRENT_TIMESTAMP
--SELECT * FROM PROP_DISTINCT_CALCS ORDER BY UWDATE DESC


--OCCUP
UPDATE PROP_DISTINCT_CALCS SET OCCUP=NULL WHERE OCCUP>1 OR OCCUP<.5
UPDATE PROP_DISTINCT_CALCS SET OCCUP=.5*(SELECT OCCUP FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) 
									+.5*(SELECT OCCUP FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE OCCUP IS NULL
UPDATE PROP_DISTINCT_CALCS SET OCCUP=(SELECT OCCUP FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE OCCUP IS NULL
UPDATE PROP_DISTINCT_CALCS SET OCCUP=(SELECT OCCUP FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE OCCUP IS NULL

--STATEMENTDATES
UPDATE PROP_DISTINCT_CALCS SET STATEMENTBEGDATE_PRIOR=(SELECT STATEMENTBEGDATE FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET STATEMENTENDDATE_PRIOR=(SELECT STATEMENTENDDATE FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET NumDaysFY=DATEDIFF(D,STATEMENTBEGDATE,STATEMENTENDDATE)
UPDATE PROP_DISTINCT_CALCS SET NumDaysFY_PRIOR=DATEDIFF(D,STATEMENTBEGDATE_PRIOR,STATEMENTENDDATE_PRIOR)
UPDATE PROP_DISTINCT_CALCS SET NumDaysFY_to_FY_PRIOR=DATEDIFF(D,STATEMENTENDDATE_PRIOR,STATEMENTENDDATE)
--REV
UPDATE PROP_DISTINCT_CALCS SET REV_PERUNIT=REV/(12*NumUnits) WHERE REV IS NOT NULL AND NumUnits>0
UPDATE PROP_DISTINCT_CALCS SET EXP_PERUNIT=EXPENSE/(12*NumUnits) WHERE EXPENSE IS NOT NULL AND NumUnits>0
UPDATE PROP_DISTINCT_CALCS SET NOI_PERUNIT=NOI/(12*NumUnits) WHERE NOI IS NOT NULL AND NumUnits>0
UPDATE PROP_DISTINCT_CALCS SET NCF_PERUNIT=NCF/(12*NumUnits) WHERE NCF IS NOT NULL AND NumUnits>0
--REV_1YRCH
UPDATE PROP_DISTINCT_CALCS SET REV_PERUNIT_1YRCH=REV_PERUNIT-(SELECT REV_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET EXP_PERUNIT_1YRCH=EXP_PERUNIT-(SELECT EXP_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET NOI_PERUNIT_1YRCH=NOI_PERUNIT-(SELECT NOI_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET NCF_PERUNIT_1YRCH=NCF_PERUNIT-(SELECT NCF_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)

UPDATE PROP_DISTINCT_CALCS SET DEBTSERVICE_PERUNIT=DEBTSERVICE/(12*NumUnits) WHERE DEBTSERVICE IS NOT NULL AND NumUnits>0
UPDATE PROP_DISTINCT_CALCS SET DSCRNOI=NOI/DEBTSERVICE WHERE DEBTSERVICE>0
UPDATE PROP_DISTINCT_CALCS SET DSCRNCF=NCF/DEBTSERVICE WHERE DEBTSERVICE>0
UPDATE PROP_DISTINCT_CALCS SET DSCRNOI=CASE WHEN DSCRNOI>10 THEN 10 ELSE CASE WHEN DSCRNOI<0 THEN 0 END END 
UPDATE PROP_DISTINCT_CALCS SET DSCRNCF=CASE WHEN DSCRNCF>10 THEN 10 ELSE CASE WHEN DSCRNCF<0 THEN 0 END END 

UPDATE PROP_DISTINCT_CALCS SET EXP_PCTREV=EXPENSE/REV WHERE EXPENSE IS NOT NULL AND REV>0 AND ABS(EXPENSE)<=2*ABS(REV)
UPDATE PROP_DISTINCT_CALCS SET NOI_PCTREV=NOI/REV WHERE NOI IS NOT NULL AND REV>0 AND ABS(NOI)<=2*ABS(REV)
UPDATE PROP_DISTINCT_CALCS SET NCF_PCTREV=NCF/REV WHERE NCF IS NOT NULL AND REV>0 AND ABS(NCF)<=2*ABS(REV)
UPDATE PROP_DISTINCT_CALCS SET DEBTSERVICE_PCTREV=DEBTSERVICE/REV WHERE DEBTSERVICE IS NOT NULL AND REV>0 AND ABS(DEBTSERVICE)<=2*ABS(REV)

UPDATE PROP_DISTINCT_CALCS SET OCCUP_1YRCH=OCCUP-(SELECT OCCUP FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET DSCRNOI_1YRCH=DSCRNOI-(SELECT DSCRNOI FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET DSCRNCF_1YRCH=DSCRNCF-(SELECT DSCRNCF FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET EXP_PCTREV_1YRCH=EXP_PCTREV-(SELECT EXP_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET NOI_PCTREV_1YRCH=NOI_PCTREV-(SELECT NOI_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET NCF_PCTREV_1YRCH=NCF_PCTREV-(SELECT NCF_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET DEBTSERVICE_PCTREV_1YRCH=DEBTSERVICE_PCTREV-(SELECT DEBTSERVICE_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)

UPDATE PROP_DISTINCT_CALCS SET DEBTSERVICE_PERUNIT_1YRCH=DEBTSERVICE_PERUNIT-(SELECT DEBTSERVICE_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)

UPDATE PROP_DISTINCT_CALCS SET OCCUP_1YRCHFWD=(SELECT OCCUP_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET DSCRNOI_1YRCHFWD=(SELECT DSCRNOI_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET DSCRNCF_1YRCHFWD=(SELECT DSCRNCF_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET EXP_PCTREV_1YRCHFWD=(SELECT EXP_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET NOI_PCTREV_1YRCHFWD=(SELECT NOI_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET NCF_PCTREV_1YRCHFWD=(SELECT NCF_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET DEBTSERVICE_PCTREV_1YRCHFWD=(SELECT DEBTSERVICE_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)

UPDATE PROP_DISTINCT_CALCS SET REV_PERUNIT_1YRCHFWD=(SELECT REV_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET EXP_PERUNIT_1YRCHFWD=(SELECT EXP_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET NOI_PERUNIT_1YRCHFWD=(SELECT NOI_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET NCF_PERUNIT_1YRCHFWD=(SELECT NCF_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET DEBTSERVICE_PERUNIT_1YRCHFWD=(SELECT DEBTSERVICE_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)

--CAPEX0
UPDATE PROP_DISTINCT_CALCS SET CAPEX0=NOI-NCF WHERE NCF>0 AND NOI>=NCF
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PCTREV=NOI_PCTREV-NCF_PCTREV WHERE NCF>0 AND NOI>=NCF
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT=NOI_PERUNIT-NCF_PERUNIT WHERE NCF>0 AND NOI>=NCF
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PCTREV_1YRCH=NOI_PCTREV_1YRCH-NCF_PCTREV_1YRCH WHERE NCF>0 AND NOI>=NCF
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT_1YRCH=NOI_PERUNIT_1YRCH-NCF_PERUNIT_1YRCH WHERE NCF>0 AND NOI>=NCF
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PCTREV_1YRCHFWD=NOI_PCTREV_1YRCHFWD-NCF_PCTREV_1YRCHFWD WHERE NCF>0 AND NOI>=NCF
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT_1YRCHFWD=NOI_PERUNIT_1YRCHFWD-NCF_PERUNIT_1YRCHFWD WHERE NCF>0 AND NOI>=NCF

--GROWTH RATES
UPDATE PROP_DISTINCT_CALCS SET REV_1YR_PCT_CH=CASE WHEN NumDaysFY_to_FY_PRIOR>0 AND ABS(REV_PERUNIT-REV_PERUNIT_1YRCH)>0 THEN (CAST(365 AS FLOAT)/NumDaysFY_to_FY_PRIOR)*REV_PERUNIT_1YRCH/(REV_PERUNIT-REV_PERUNIT_1YRCH) END 
UPDATE PROP_DISTINCT_CALCS SET EXP_1YR_PCT_CH=CASE WHEN NumDaysFY_to_FY_PRIOR>0 AND ABS(EXP_PERUNIT-EXP_PERUNIT_1YRCH)>0 THEN (CAST(365 AS FLOAT)/NumDaysFY_to_FY_PRIOR)*EXP_PERUNIT_1YRCH/(EXP_PERUNIT-EXP_PERUNIT_1YRCH) END
UPDATE PROP_DISTINCT_CALCS SET NOI_1YR_PCT_CH=CASE WHEN NumDaysFY_to_FY_PRIOR>0 AND ABS(NOI_PERUNIT-NOI_PERUNIT_1YRCH)>0 THEN (CAST(365 AS FLOAT)/NumDaysFY_to_FY_PRIOR)*NOI_PERUNIT_1YRCH/(NOI_PERUNIT-NOI_PERUNIT_1YRCH) END
UPDATE PROP_DISTINCT_CALCS SET NCF_1YR_PCT_CH=CASE WHEN NumDaysFY_to_FY_PRIOR>0 AND ABS(NCF_PERUNIT-NCF_PERUNIT_1YRCH)>0 THEN (CAST(365 AS FLOAT)/NumDaysFY_to_FY_PRIOR)*NCF_PERUNIT_1YRCH/(NCF_PERUNIT-NCF_PERUNIT_1YRCH) END
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_1YR_PCT_CH=CASE WHEN NumDaysFY_to_FY_PRIOR>0 AND ABS(CAPEX0_PERUNIT-CAPEX0_PERUNIT_1YRCH)>0 THEN (CAST(365 AS FLOAT)/NumDaysFY_to_FY_PRIOR)*CAPEX0_PERUNIT_1YRCH/(CAPEX0_PERUNIT-CAPEX0_PERUNIT_1YRCH) END
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_1YR_PCT_CH=CASE WHEN CAPEX0_1YR_PCT_CH>2 THEN 2 ELSE CASE WHEN CAPEX0_1YR_PCT_CH<-.99 THEN -.99 ELSE CAPEX0_1YR_PCT_CH END END

--FWD GROWTH RATES
UPDATE PROP_DISTINCT_CALCS SET REV_1YR_PCT_CH_FWD=(SELECT REV_1YR_PCT_CH FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET EXP_1YR_PCT_CH_FWD=(SELECT EXP_1YR_PCT_CH FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET NOI_1YR_PCT_CH_FWD=(SELECT NOI_1YR_PCT_CH FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET NCF_1YR_PCT_CH_FWD=(SELECT NCF_1YR_PCT_CH FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_1YR_PCT_CH_FWD=(SELECT CAPEX0_1YR_PCT_CH FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)

UPDATE PROP_DISTINCT_CALCS SET REV_1YR_PCT_CH=NULL,EXP_1YR_PCT_CH=NULL,NOI_1YR_PCT_CH=NULL,NCF_1YR_PCT_CH=NULL
WHERE ABS(REV_1YR_PCT_CH)>.75 OR ABS(EXP_1YR_PCT_CH)>.75 OR ABS(NOI_1YR_PCT_CH)>1

UPDATE PROP_DISTINCT_CALCS SET REV_1YR_PCT_CH_FWD=NULL,EXP_1YR_PCT_CH_FWD=NULL,NOI_1YR_PCT_CH_FWD=NULL,NCF_1YR_PCT_CH_FWD=NULL
WHERE ABS(REV_1YR_PCT_CH_FWD)>.75 OR ABS(EXP_1YR_PCT_CH_FWD)>.75 OR ABS(NOI_1YR_PCT_CH_FWD)>1

UPDATE PROP_DISTINCT_CALCS SET REV_2YR_PCT_CH_FWD=(1+REV_1YR_PCT_CH_FWD)*(1+(SELECT REV_1YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET EXP_2YR_PCT_CH_FWD=(1+EXP_1YR_PCT_CH_FWD)*(1+(SELECT EXP_1YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET NOI_2YR_PCT_CH_FWD=(1+NOI_1YR_PCT_CH_FWD)*(1+(SELECT NOI_1YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET NCF_2YR_PCT_CH_FWD=(1+NCF_1YR_PCT_CH_FWD)*(1+(SELECT NCF_1YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_2YR_PCT_CH_FWD=(1+CAPEX0_1YR_PCT_CH_FWD)*(1+(SELECT CAPEX0_1YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1

UPDATE PROP_DISTINCT_CALCS SET REV_3YR_PCT_CH_FWD=(1+REV_1YR_PCT_CH_FWD)*(1+(SELECT REV_2YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET EXP_3YR_PCT_CH_FWD=(1+EXP_1YR_PCT_CH_FWD)*(1+(SELECT EXP_2YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET NOI_3YR_PCT_CH_FWD=(1+NOI_1YR_PCT_CH_FWD)*(1+(SELECT NOI_2YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET NCF_3YR_PCT_CH_FWD=(1+NCF_1YR_PCT_CH_FWD)*(1+(SELECT NCF_2YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_3YR_PCT_CH_FWD=(1+CAPEX0_1YR_PCT_CH_FWD)*(1+(SELECT CAPEX0_2YR_PCT_CH_FWD FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1))-1

--FF
UPDATE PROP_DISTINCT_CALCS SET GROSRNT_PCTREV=GROSRNT/REV WHERE GROSRNT IS NOT NULL AND REV>0 AND ABS(GROSRNT)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET VACANCY_PCTREV=VACANCY/REV WHERE VACANCY IS NOT NULL AND REV>0 AND ABS(VACANCY)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET BASERNT_PCTREV=BASERNT/REV WHERE BASERNT IS NOT NULL AND REV>0 AND ABS(BASERNT)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET LAUNDRY_PCTREV=LAUNDRY/REV WHERE LAUNDRY IS NOT NULL AND REV>0 AND ABS(LAUNDRY)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PARKING_PCTREV=PARKING/REV WHERE PARKING IS NOT NULL AND REV>0 AND ABS(PARKING)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET OTHERIN_PCTREV=OTHERIN/REV WHERE OTHERIN IS NOT NULL AND REV>0 AND ABS(OTHERIN)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET RETAXES_PCTREV=RETAXES/REV WHERE RETAXES IS NOT NULL AND REV>0 AND ABS(RETAXES)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PROPINS_PCTREV=PROPINS/REV WHERE PROPINS IS NOT NULL AND REV>0 AND ABS(PROPINS)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET UTILITI_PCTREV=UTILITI/REV WHERE UTILITI IS NOT NULL AND REV>0 AND ABS(UTILITI)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET REPAIRS_PCTREV=REPAIRS/REV WHERE REPAIRS IS NOT NULL AND REV>0 AND ABS(REPAIRS)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET MANAGEM_PCTREV=MANAGEM/REV WHERE MANAGEM IS NOT NULL AND REV>0 AND ABS(MANAGEM)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PAYROLL_PCTREV=PAYROLL/REV WHERE PAYROLL IS NOT NULL AND REV>0 AND ABS(PAYROLL)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET MARKETI_PCTREV=MARKETI/REV WHERE MARKETI IS NOT NULL AND REV>0 AND ABS(MARKETI)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PROFESS_PCTREV=PROFESS/REV WHERE PROFESS IS NOT NULL AND REV>0 AND ABS(PROFESS)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET GENERAL_PCTREV=GENERAL/REV WHERE GENERAL IS NOT NULL AND REV>0 AND ABS(GENERAL)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET OTHEREX_PCTREV=OTHEREX/REV WHERE OTHEREX IS NOT NULL AND REV>0 AND ABS(OTHEREX)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET GROUNDR_PCTREV=GROUNDR/REV WHERE GROUNDR IS NOT NULL AND REV>0 AND ABS(GROUNDR)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET CAPEX_PCTREV=CAPEX/REV WHERE CAPEX IS NOT NULL AND REV>0 AND ABS(NOI)<=10*ABS(CAPEX) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET EXCAPEX_PCTREV=EXCAPEX/REV WHERE EXCAPEX IS NOT NULL AND REV>0 AND ABS(NOI)<=10*ABS(EXCAPEX) AND HasFF=1

UPDATE PROP_DISTINCT_CALCS SET GROSRNT_PERUNIT=GROSRNT/(12*NumUnits) WHERE GROSRNT IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET VACANCY_PERUNIT=VACANCY/(12*NumUnits) WHERE VACANCY IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET BASERNT_PERUNIT=BASERNT/(12*NumUnits) WHERE BASERNT IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET LAUNDRY_PERUNIT=LAUNDRY/(12*NumUnits) WHERE LAUNDRY IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PARKING_PERUNIT=PARKING/(12*NumUnits) WHERE PARKING IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET OTHERIN_PERUNIT=OTHERIN/(12*NumUnits) WHERE OTHERIN IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET RETAXES_PERUNIT=RETAXES/(12*NumUnits) WHERE RETAXES IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PROPINS_PERUNIT=PROPINS/(12*NumUnits) WHERE PROPINS IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET UTILITI_PERUNIT=UTILITI/(12*NumUnits) WHERE UTILITI IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET REPAIRS_PERUNIT=REPAIRS/(12*NumUnits) WHERE REPAIRS IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET MANAGEM_PERUNIT=MANAGEM/(12*NumUnits) WHERE MANAGEM IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PAYROLL_PERUNIT=PAYROLL/(12*NumUnits) WHERE PAYROLL IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET MARKETI_PERUNIT=MARKETI/(12*NumUnits) WHERE MARKETI IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET PROFESS_PERUNIT=PROFESS/(12*NumUnits) WHERE PROFESS IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET GENERAL_PERUNIT=GENERAL/(12*NumUnits) WHERE GENERAL IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET OTHEREX_PERUNIT=OTHEREX/(12*NumUnits) WHERE OTHEREX IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET GROUNDR_PERUNIT=GROUNDR/(12*NumUnits) WHERE GROUNDR IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET CAPEX_PERUNIT=CAPEX/(12*NumUnits) WHERE CAPEX IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET EXCAPEX_PERUNIT=EXCAPEX/(12*NumUnits) WHERE EXCAPEX IS NOT NULL AND NumUnits>0 AND HasFF=1

UPDATE PROP_DISTINCT_CALCS SET GROSRNT_PCTREV_1YRCH=GROSRNT_PCTREV-(SELECT GROSRNT_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET VACANCY_PCTREV_1YRCH=VACANCY_PCTREV-(SELECT VACANCY_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET BASERNT_PCTREV_1YRCH=BASERNT_PCTREV-(SELECT BASERNT_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET LAUNDRY_PCTREV_1YRCH=LAUNDRY_PCTREV-(SELECT LAUNDRY_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PARKING_PCTREV_1YRCH=PARKING_PCTREV-(SELECT PARKING_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET OTHERIN_PCTREV_1YRCH=OTHERIN_PCTREV-(SELECT OTHERIN_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET RETAXES_PCTREV_1YRCH=RETAXES_PCTREV-(SELECT RETAXES_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PROPINS_PCTREV_1YRCH=PROPINS_PCTREV-(SELECT PROPINS_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET UTILITI_PCTREV_1YRCH=UTILITI_PCTREV-(SELECT UTILITI_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET REPAIRS_PCTREV_1YRCH=REPAIRS_PCTREV-(SELECT REPAIRS_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET MANAGEM_PCTREV_1YRCH=MANAGEM_PCTREV-(SELECT MANAGEM_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PAYROLL_PCTREV_1YRCH=PAYROLL_PCTREV-(SELECT PAYROLL_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET MARKETI_PCTREV_1YRCH=MARKETI_PCTREV-(SELECT MARKETI_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PROFESS_PCTREV_1YRCH=PROFESS_PCTREV-(SELECT PROFESS_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET GENERAL_PCTREV_1YRCH=GENERAL_PCTREV-(SELECT GENERAL_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET OTHEREX_PCTREV_1YRCH=OTHEREX_PCTREV-(SELECT OTHEREX_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET GROUNDR_PCTREV_1YRCH=GROUNDR_PCTREV-(SELECT GROUNDR_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET CAPEX_PCTREV_1YRCH=CAPEX_PCTREV-(SELECT CAPEX_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET EXCAPEX_PCTREV_1YRCH=EXCAPEX_PCTREV-(SELECT EXCAPEX_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)

UPDATE PROP_DISTINCT_CALCS SET GROSRNT_PERUNIT_1YRCH=GROSRNT_PERUNIT-(SELECT GROSRNT_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET VACANCY_PERUNIT_1YRCH=VACANCY_PERUNIT-(SELECT VACANCY_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET BASERNT_PERUNIT_1YRCH=BASERNT_PERUNIT-(SELECT BASERNT_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET LAUNDRY_PERUNIT_1YRCH=LAUNDRY_PERUNIT-(SELECT LAUNDRY_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PARKING_PERUNIT_1YRCH=PARKING_PERUNIT-(SELECT PARKING_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET OTHERIN_PERUNIT_1YRCH=OTHERIN_PERUNIT-(SELECT OTHERIN_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET RETAXES_PERUNIT_1YRCH=RETAXES_PERUNIT-(SELECT RETAXES_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PROPINS_PERUNIT_1YRCH=PROPINS_PERUNIT-(SELECT PROPINS_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET UTILITI_PERUNIT_1YRCH=UTILITI_PERUNIT-(SELECT UTILITI_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET REPAIRS_PERUNIT_1YRCH=REPAIRS_PERUNIT-(SELECT REPAIRS_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET MANAGEM_PERUNIT_1YRCH=MANAGEM_PERUNIT-(SELECT MANAGEM_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PAYROLL_PERUNIT_1YRCH=PAYROLL_PERUNIT-(SELECT PAYROLL_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET MARKETI_PERUNIT_1YRCH=MARKETI_PERUNIT-(SELECT MARKETI_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET PROFESS_PERUNIT_1YRCH=PROFESS_PERUNIT-(SELECT PROFESS_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET GENERAL_PERUNIT_1YRCH=GENERAL_PERUNIT-(SELECT GENERAL_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET OTHEREX_PERUNIT_1YRCH=OTHEREX_PERUNIT-(SELECT OTHEREX_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET GROUNDR_PERUNIT_1YRCH=GROUNDR_PERUNIT-(SELECT GROUNDR_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET CAPEX_PERUNIT_1YRCH=CAPEX_PERUNIT-(SELECT CAPEX_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
UPDATE PROP_DISTINCT_CALCS SET EXCAPEX_PERUNIT_1YRCH=EXCAPEX_PERUNIT-(SELECT EXCAPEX_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)

UPDATE PROP_DISTINCT_CALCS SET GROSRNT_PCTREV_1YRCHFWD=(SELECT GROSRNT_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET VACANCY_PCTREV_1YRCHFWD=(SELECT VACANCY_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET BASERNT_PCTREV_1YRCHFWD=(SELECT BASERNT_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET LAUNDRY_PCTREV_1YRCHFWD=(SELECT LAUNDRY_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PARKING_PCTREV_1YRCHFWD=(SELECT PARKING_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET OTHERIN_PCTREV_1YRCHFWD=(SELECT OTHERIN_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET RETAXES_PCTREV_1YRCHFWD=(SELECT RETAXES_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PROPINS_PCTREV_1YRCHFWD=(SELECT PROPINS_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET UTILITI_PCTREV_1YRCHFWD=(SELECT UTILITI_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET REPAIRS_PCTREV_1YRCHFWD=(SELECT REPAIRS_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET MANAGEM_PCTREV_1YRCHFWD=(SELECT MANAGEM_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PAYROLL_PCTREV_1YRCHFWD=(SELECT PAYROLL_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET MARKETI_PCTREV_1YRCHFWD=(SELECT MARKETI_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PROFESS_PCTREV_1YRCHFWD=(SELECT PROFESS_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET GENERAL_PCTREV_1YRCHFWD=(SELECT GENERAL_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET OTHEREX_PCTREV_1YRCHFWD=(SELECT OTHEREX_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET GROUNDR_PCTREV_1YRCHFWD=(SELECT GROUNDR_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET CAPEX_PCTREV_1YRCHFWD=(SELECT CAPEX_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET EXCAPEX_PCTREV_1YRCHFWD=(SELECT EXCAPEX_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)

UPDATE PROP_DISTINCT_CALCS SET GROSRNT_PERUNIT_1YRCHFWD=(SELECT GROSRNT_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET VACANCY_PERUNIT_1YRCHFWD=(SELECT VACANCY_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET BASERNT_PERUNIT_1YRCHFWD=(SELECT BASERNT_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET LAUNDRY_PERUNIT_1YRCHFWD=(SELECT LAUNDRY_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PARKING_PERUNIT_1YRCHFWD=(SELECT PARKING_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET OTHERIN_PERUNIT_1YRCHFWD=(SELECT OTHERIN_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET RETAXES_PERUNIT_1YRCHFWD=(SELECT RETAXES_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PROPINS_PERUNIT_1YRCHFWD=(SELECT PROPINS_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET UTILITI_PERUNIT_1YRCHFWD=(SELECT UTILITI_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET REPAIRS_PERUNIT_1YRCHFWD=(SELECT REPAIRS_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET MANAGEM_PERUNIT_1YRCHFWD=(SELECT MANAGEM_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PAYROLL_PERUNIT_1YRCHFWD=(SELECT PAYROLL_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET MARKETI_PERUNIT_1YRCHFWD=(SELECT MARKETI_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET PROFESS_PERUNIT_1YRCHFWD=(SELECT PROFESS_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET GENERAL_PERUNIT_1YRCHFWD=(SELECT GENERAL_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET OTHEREX_PERUNIT_1YRCHFWD=(SELECT OTHEREX_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET GROUNDR_PERUNIT_1YRCHFWD=(SELECT GROUNDR_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET CAPEX_PERUNIT_1YRCHFWD=(SELECT CAPEX_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)
UPDATE PROP_DISTINCT_CALCS SET EXCAPEX_PERUNIT_1YRCHFWD=(SELECT EXCAPEX_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1)

--CAPEX
UPDATE PROP_DISTINCT_CALCS SET
CAPEX=NOI-NCF,
CAPEX_PERUNIT=NOI_PERUNIT-NCF_PERUNIT,
CAPEX_PCTREV=NOI_PCTREV-NCF_PCTREV,
CAPEX_PERUNIT_1YRCH=NOI_PERUNIT_1YRCH-NCF_PERUNIT_1YRCH,
CAPEX_PCTREV_1YRCH=NOI_PCTREV_1YRCH-NCF_PCTREV_1YRCH,
CAPEX_PERUNIT_1YRCHFWD=NOI_PERUNIT_1YRCHFWD-NCF_PERUNIT_1YRCHFWD

--CAPEX0
UPDATE PROP_DISTINCT_CALCS SET CAPEX0=CAPEX WHERE CAPEX IS NOT NULL
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PCTREV=CAPEX_PCTREV WHERE CAPEX_PCTREV IS NOT NULL
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT=CAPEX_PERUNIT WHERE CAPEX_PERUNIT IS NOT NULL
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PCTREV_1YRCH=CAPEX_PCTREV_1YRCH WHERE CAPEX_PCTREV_1YRCH IS NOT NULL
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT_1YRCH=CAPEX_PERUNIT_1YRCH WHERE CAPEX_PERUNIT_1YRCH IS NOT NULL
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PCTREV_1YRCHFWD=CAPEX_PCTREV_1YRCHFWD WHERE CAPEX_PCTREV_1YRCHFWD IS NOT NULL
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT_1YRCHFWD=CAPEX_PERUNIT_1YRCHFWD WHERE CAPEX_PERUNIT_1YRCHFWD IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET 
CAPEX0=NULL,
CAPEX0_PCTREV=NULL,
CAPEX0_PCTREV_1YRCH=NULL,
CAPEX0_PERUNIT_1YRCH=NULL,
CAPEX0_PCTREV_1YRCHFWD=NULL,
CAPEX0_PERUNIT_1YRCHFWD=NULL 
WHERE (CAPEX0 IS NULL OR CAPEX0_PCTREV<0 OR CAPEX0_PCTREV>.5)

--HC
UPDATE PROP_DISTINCT_CALCS SET HC_INC_PVTPAY_PCTREV=HC_INC_PVTPAY/REV WHERE HC_INC_PVTPAY IS NOT NULL AND REV>0 AND ABS(HC_INC_PVTPAY)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEDCARE_PCTREV=HC_INC_MEDCARE/REV WHERE HC_INC_MEDCARE IS NOT NULL AND REV>0 AND ABS(HC_INC_MEDCARE)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_NURSING_PCTREV=HC_INC_NURSING/REV WHERE HC_INC_NURSING IS NOT NULL AND REV>0 AND ABS(HC_INC_NURSING)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEALS_PCTREV=HC_INC_MEALS/REV WHERE HC_INC_MEALS IS NOT NULL AND REV>0 AND ABS(HC_INC_MEALS)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_ROOMS_PCTREV=HC_EXP_ROOMS/REV WHERE HC_EXP_ROOMS IS NOT NULL AND REV>0 AND ABS(HC_EXP_ROOMS)<=2*ABS(REV) AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_MEALS_PCTREV=HC_EXP_MEALS/REV WHERE HC_EXP_MEALS IS NOT NULL AND REV>0 AND ABS(HC_EXP_MEALS)<=2*ABS(REV) AND HasFF=1

UPDATE PROP_DISTINCT_CALCS SET HC_INC_PVTPAY_PERUNIT=HC_INC_PVTPAY/(12*NumUnits) WHERE HC_INC_PVTPAY IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEDCARE_PERUNIT=HC_INC_MEDCARE/(12*NumUnits) WHERE HC_INC_MEDCARE IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_NURSING_PERUNIT=HC_INC_NURSING/(12*NumUnits) WHERE HC_INC_NURSING IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEALS_PERUNIT=HC_INC_MEALS/(12*NumUnits) WHERE HC_INC_MEALS IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_ROOMS_PERUNIT=HC_EXP_ROOMS/(12*NumUnits) WHERE HC_EXP_ROOMS IS NOT NULL AND NumUnits>0 AND HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_MEALS_PERUNIT=HC_EXP_MEALS/(12*NumUnits) WHERE HC_EXP_MEALS IS NOT NULL AND NumUnits>0 AND HasFF=1

UPDATE PROP_DISTINCT_CALCS SET HC_INC_PVTPAY_PCTREV_1YRCH=HC_INC_PVTPAY_PCTREV-(SELECT HC_INC_PVTPAY_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEDCARE_PCTREV_1YRCH=HC_INC_MEDCARE_PCTREV-(SELECT HC_INC_MEDCARE_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_NURSING_PCTREV_1YRCH=HC_INC_NURSING_PCTREV-(SELECT HC_INC_NURSING_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEALS_PCTREV_1YRCH=HC_INC_MEALS_PCTREV-(SELECT HC_INC_MEALS_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_ROOMS_PCTREV_1YRCH=HC_EXP_ROOMS_PCTREV-(SELECT HC_EXP_ROOMS_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_MEALS_PCTREV_1YRCH=HC_EXP_MEALS_PCTREV-(SELECT HC_EXP_MEALS_PCTREV FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1

UPDATE PROP_DISTINCT_CALCS SET HC_INC_PVTPAY_PERUNIT_1YRCH=HC_INC_PVTPAY_PERUNIT-(SELECT HC_INC_PVTPAY_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEDCARE_PERUNIT_1YRCH=HC_INC_MEDCARE_PERUNIT-(SELECT HC_INC_MEDCARE_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_NURSING_PERUNIT_1YRCH=HC_INC_NURSING_PERUNIT-(SELECT HC_INC_NURSING_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEALS_PERUNIT_1YRCH=HC_INC_MEALS_PERUNIT-(SELECT HC_INC_MEALS_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_ROOMS_PERUNIT_1YRCH=HC_EXP_ROOMS_PERUNIT-(SELECT HC_EXP_ROOMS_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_MEALS_PERUNIT_1YRCH=HC_EXP_MEALS_PERUNIT-(SELECT HC_EXP_MEALS_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1) WHERE HasFF=1

UPDATE PROP_DISTINCT_CALCS SET HC_INC_PVTPAY_PCTREV_1YRCHFWD=(SELECT HC_INC_PVTPAY_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEDCARE_PCTREV_1YRCHFWD=(SELECT HC_INC_MEDCARE_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_NURSING_PCTREV_1YRCHFWD=(SELECT HC_INC_NURSING_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEALS_PCTREV_1YRCHFWD=(SELECT HC_INC_MEALS_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_ROOMS_PCTREV_1YRCHFWD=(SELECT HC_EXP_ROOMS_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_MEALS_PCTREV_1YRCHFWD=(SELECT HC_EXP_MEALS_PCTREV_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1

UPDATE PROP_DISTINCT_CALCS SET HC_INC_PVTPAY_PERUNIT_1YRCHFWD=(SELECT HC_INC_PVTPAY_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEDCARE_PERUNIT_1YRCHFWD=(SELECT HC_INC_MEDCARE_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_NURSING_PERUNIT_1YRCHFWD=(SELECT HC_INC_NURSING_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_INC_MEALS_PERUNIT_1YRCHFWD=(SELECT HC_INC_MEALS_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_ROOMS_PERUNIT_1YRCHFWD=(SELECT HC_EXP_ROOMS_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1
UPDATE PROP_DISTINCT_CALCS SET HC_EXP_MEALS_PERUNIT_1YRCHFWD=(SELECT HC_EXP_MEALS_PERUNIT_1YRCH FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR+1) WHERE HasFF=1

--VAL
UPDATE PROP_DISTINCT_CALCS SET VAL_PERUNIT=(VALUATIONAMOUNT/NumUnits) WHERE NumUnits>0 and HasVal=1
UPDATE PROP_DISTINCT_CALCS SET VAL_CAPRATE=NOI/VALUATIONAMOUNT WHERE NOI>0 AND VALUATIONAMOUNT>0 and HasVal=1
UPDATE PROP_DISTINCT_CALCS SET VAL_CAPRATE=(SELECT NOI FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)/VALUATIONAMOUNT 
								WHERE VAL_CAPRATE IS NULL
								AND (SELECT NOI FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)>0
								AND VALUATIONAMOUNT>0 and HasVal=1
--UW
UPDATE PROP_DISTINCT_CALCS SET UW_NOI_ACTUAL_RATIO=NULL WHERE HasUW=0
UPDATE PROP_DISTINCT_CALCS SET VAL_UW_PERUNIT=(VAL_UW/NumUnits) WHERE NumUnits>0 and HasUW=1
UPDATE PROP_DISTINCT_CALCS SET UW_CAPRATE=NOI_UW/VAL_UW WHERE NOI_UW>.01*VAL_UW AND NOI_UW<.1*VAL_UW AND UW_NOI_ACTUAL_RATIO>0 and HasUW=1
UPDATE PROP_DISTINCT_CALCS SET NCF_UW=(REV_UW-EXP_UW)+(NCF_UW-NOI_UW) WHERE HasUW=1
UPDATE PROP_DISTINCT_CALCS SET NOI_UW=(REV_UW-EXP_UW) WHERE HasUW=1
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_UW=(NOI_UW-NCF_UW) WHERE HasUW=1

UPDATE PROP_DISTINCT_CALCS SET DSCRNCF_IO=(NCF_UW/DEBTSERVICE_IO_UW) WHERE DEBTSERVICE_IO_UW>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET DSCRNCF_AMORT=(NCF_UW/DEBTSERVICE_AMORT_UW) WHERE DEBTSERVICE_AMORT_UW>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET DSCRNCF_CAP=(NCF_UW/DEBTSERVICE_CAP_UW) WHERE DEBTSERVICE_CAP_UW>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET EXP_UW_PCTREV=(EXP_UW/REV_UW) WHERE REV_UW>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET NOI_UW_PCTREV=(NOI_UW/REV_UW) WHERE REV_UW>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET NCF_UW_PCTREV=(NCF_UW/REV_UW) WHERE REV_UW>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_UW_PCTREV=(CAPEX0_UW/REV_UW) WHERE REV_UW>0 AND HasUW=1

UPDATE PROP_DISTINCT_CALCS SET REV_UW_PERUNIT=REV_UW/(12*NumUnits) WHERE NumUnits>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET EXP_UW_PERUNIT=EXP_UW/(12*NumUnits) WHERE NumUnits>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET NOI_UW_PERUNIT=NOI_UW/(12*NumUnits) WHERE NumUnits>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET NCF_UW_PERUNIT=NCF_UW/(12*NumUnits) WHERE NumUnits>0 AND HasUW=1
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_UW_PERUNIT=CAPEX0_UW/(12*NumUnits) WHERE NumUnits>0 AND HasUW=1

UPDATE PROP_DISTINCT_CALCS SET HASVAL=0
UPDATE PROP_DISTINCT_CALCS SET HASVAL=1 WHERE VALUATIONAMOUNT>0
UPDATE PROP_DISTINCT_CALCS SET HASORIG=0
UPDATE PROP_DISTINCT_CALCS SET HASORIG=1 WHERE YEAR(LOANORIGDATE)=STATEMENTYEAR
UPDATE PROP_DISTINCT_CALCS SET HASUW=0
UPDATE PROP_DISTINCT_CALCS SET HASUW=1 WHERE REV_UW>0

UPDATE PROP_DISTINCT_CALCS SET HasFF=0 WHERE
(GROSRNT IS NULL OR GROSRNT=0)
AND (VACANCY IS NULL OR VACANCY=0)
AND (BASERNT IS NULL OR BASERNT=0)
AND (HC_INC_PVTPAY IS NULL OR HC_INC_PVTPAY=0)
AND (HC_INC_MEDCARE IS NULL OR HC_INC_MEDCARE=0)
AND (HC_INC_NURSING IS NULL OR HC_INC_NURSING=0)
AND (HC_INC_MEALS IS NULL OR HC_INC_MEALS=0)
AND (LAUNDRY IS NULL OR LAUNDRY=0)
AND (PARKING IS NULL OR PARKING=0)
AND (OTHERIN IS NULL OR OTHERIN=0)

UPDATE PROP_DISTINCT_CALCS SET HasFF=0 WHERE
(RETAXES IS NULL OR RETAXES=0)
AND (PROPINS IS NULL OR PROPINS=0)
AND (UTILITI IS NULL OR UTILITI=0)
AND (REPAIRS IS NULL OR REPAIRS=0)
AND (MANAGEM IS NULL OR MANAGEM=0)
AND (PAYROLL IS NULL OR PAYROLL=0)
AND (MARKETI IS NULL OR MARKETI=0)
AND (PROFESS IS NULL OR PROFESS=0)
AND (GENERAL IS NULL OR GENERAL=0)
AND (HC_EXP_ROOMS IS NULL OR HC_EXP_ROOMS=0)
AND (HC_EXP_MEALS IS NULL OR HC_EXP_MEALS=0)
AND (OTHEREX IS NULL OR OTHEREX=0)
AND (GROUNDR IS NULL OR GROUNDR=0)
AND (CAPEX IS NULL OR CAPEX=0)
AND (EXCAPEX IS NULL  OR EXCAPEX=0)

UPDATE PROP_DISTINCT_CALCS SET HasDATA=0
UPDATE PROP_DISTINCT_CALCS SET HasDATA=1 WHERE HasORIG=1 OR HasREV=1 OR HasUW=1 OR HasVAL=1 OR HasFF=1
DELETE FROM PROP_DISTINCT_CALCS WHERE HasDATA=0

UPDATE PROP_DISTINCT_CALCS SET STATEMENTYEAR_MOSTRECENT=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS P WHERE HASDATA=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR)
UPDATE PROP_DISTINCT_CALCS SET REVYEAR_MOSTRECENT=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS P WHERE HASREV=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR)
UPDATE PROP_DISTINCT_CALCS SET FFYEAR_MOSTRECENT=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS P WHERE HasFF=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR)
UPDATE PROP_DISTINCT_CALCS SET VALYEAR_MOSTRECENT=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS P WHERE HASVAL=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR)
UPDATE PROP_DISTINCT_CALCS SET UWYEAR_MOSTRECENT=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS P WHERE HASUW=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR)
UPDATE PROP_DISTINCT_CALCS SET ORIGYEAR_MOSTRECENT=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS P WHERE HASORIG=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR)

UPDATE PROP_DISTINCT_CALCS SET OCCUP_MOSTRECENT=(SELECT MAX(OCCUP) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.REVYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET REV_PERUNIT_MOSTRECENT=(SELECT MAX(REV_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.REVYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET EXP_PERUNIT_MOSTRECENT=(SELECT MAX(EXP_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.REVYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET NOI_PERUNIT_MOSTRECENT=(SELECT MAX(NOI_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.REVYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET NCF_PERUNIT_MOSTRECENT=(SELECT MAX(NCF_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.REVYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET CAPEX0_PERUNIT_MOSTRECENT=(SELECT MAX(CAPEX0_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.REVYEAR_MOSTRECENT)

UPDATE PROP_DISTINCT_CALCS SET VALAMT_MOSTRECENT=(SELECT VALUATIONAMOUNT FROM PROP_DISTINCT_CALCS P WHERE HASVAL=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND STATEMENTYEAR=PROP_DISTINCT_CALCS.VALYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET VALDATE_MOSTRECENT=(SELECT VALUATIONDATE FROM PROP_DISTINCT_CALCS P WHERE HASVAL=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND STATEMENTYEAR=PROP_DISTINCT_CALCS.VALYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET VAL_PERUNIT_MOSTRECENT=(SELECT VAL_PERUNIT FROM PROP_DISTINCT_CALCS P WHERE HASVAL=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND STATEMENTYEAR=PROP_DISTINCT_CALCS.VALYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET VAL_CAPRATE_MOSTRECENT=(SELECT VAL_CAPRATE FROM PROP_DISTINCT_CALCS P WHERE HASVAL=1 AND P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND STATEMENTYEAR=PROP_DISTINCT_CALCS.VALYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_CAPRATE_MOSTRECENT=(SELECT MAX(UW_CAPRATE) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_VAL_PERUNIT_MOSTRECENT=(SELECT MAX(VAL_UW_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_REV_PERUNIT_MOSTRECENT=(SELECT MAX(REV_UW_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_EXP_PERUNIT_MOSTRECENT=(SELECT MAX(EXP_UW_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_NOI_PERUNIT_MOSTRECENT=(SELECT MAX(NOI_UW_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_NCF_PERUNIT_MOSTRECENT=(SELECT MAX(NCF_UW_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)
UPDATE PROP_DISTINCT_CALCS SET UW_CAPEX0_PERUNIT_MOSTRECENT=(SELECT MAX(CAPEX0_UW_PERUNIT) FROM PROP_DISTINCT_CALCS P WHERE P.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND P.STATEMENTYEAR=P.UWYEAR_MOSTRECENT)

DECLARE @REFERENCEYEAR INT
SELECT @REFERENCEYEAR=(SELECT MAX(REFERENCEYEAR) FROM PROP_DEMOGRAPHIC_SCORE)
UPDATE PROP_DISTINCT_CALCS SET 
DEMOGRAPHIC_SCORE=(SELECT MAX(INPUT_DEMOGRAPHIC_SCORE) FROM PROP_DEMOGRAPHIC_SCORE X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND REFERENCEYEAR=@REFERENCEYEAR)

UPDATE PROP_DISTINCT_CALCS SET
ELEVATORSYN=(SELECT ELEVATORSYN FROM LPLIST_ALL X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID),
LOWINCOMEUNITS=(SELECT LOWINCOMEUNITS FROM LPLIST_ALL X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID),
VERYLOWINCOMEUNITS=(SELECT VERYLOWINCOMEUNITS FROM LPLIST_ALL X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID),
HUD_PROJECT_NUMBER=(SELECT MAX(HUD_PROJECT_NUMBER) FROM HUD_PROJECT_LOANS X WHERE X.EXID_PLID_PRID_MATCH=PROP_DISTINCT_CALCS.EXID_PLID_PRID),
SEC8_PROPERTYID=(SELECT MAX(property_id) FROM HUD_SEC8_PROPERTIES X WHERE X.EXID_PLID_PRID_MATCH=PROP_DISTINCT_CALCS.EXID_PLID_PRID)

UPDATE PROP_DISTINCT_CALCS SET
CENSUSYEAR=(SELECT MAX(CENSUSYEAR) FROM CENSUSDATA_USED C WHERE C.CENSUSYEAR<=PROP_DISTINCT_CALCS.STATEMENTYEAR AND C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND C.PopulationPerSqMile>0)

UPDATE PROP_DISTINCT_CALCS SET
CENSUSYEAR=(SELECT MIN(CENSUSYEAR) FROM CENSUSDATA_USED C WHERE C.CENSUSYEAR>=PROP_DISTINCT_CALCS.STATEMENTYEAR AND C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND C.PopulationPerSqMile>0)
WHERE CENSUSYEAR IS NULL

UPDATE PROP_DISTINCT_CALCS SET 
PopulationPerSqMile=(SELECT AVG(PopulationPerSqMile) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
MedianAge=(SELECT AVG(MedianAge) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
MovedIn2010orLaterPCT=(SELECT AVG(MovedIn2010orLaterPCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
MedianHHInc=(SELECT AVG(MedianHHInc) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
MedianHomeVal=(SELECT AVG(MedianHomeVal) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
Median_Rent=(SELECT AVG(Median_Rent) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
Median_Owner_Costs=(SELECT AVG(Median_Owner_Costs) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
RenterPCT=(SELECT AVG(RenterPCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
CashRentOver30PCT=(SELECT AVG(CashRentOver30PCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
BachelorsOrMorePCT=(SELECT AVG(BachelorsOrMorePCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
UnemploymentPCT=(SELECT AVG(UnemploymentPCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
LogisticsPCT=(SELECT AVG(LogisticsPCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
MngtFinancePCT=(SELECT AVG(MngtFinancePCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR), 
PublicAssistPCT=(SELECT AVG(PublicAssistPCT) FROM CENSUSDATA_USED C WHERE C.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND PROP_DISTINCT_CALCS.CENSUSYEAR=C.CENSUSYEAR)


UPDATE PROP_DISTINCT_CALCS SET 
RATEAVGYEAR_TRSY1M=(SELECT AVG(TRSY1M) FROM RATEDATA WHERE YEAR(CLOSEDATE)=PROP_DISTINCT_CALCS.STATEMENTYEAR),
RATEAVGYEAR_TRSY10Y=(SELECT AVG(TRSY10Y) FROM RATEDATA WHERE YEAR(CLOSEDATE)=PROP_DISTINCT_CALCS.STATEMENTYEAR),
RATEAVG3MORIG_TRSY1M=(SELECT AVG(TRSY1M) FROM RATEDATA WHERE DATEDIFF(M,CLOSEDATE,PROP_DISTINCT_CALCS.LOANORIGDATE)<=3),
RATEAVG3MORIG_TRSY10Y=(SELECT AVG(TRSY10Y) FROM RATEDATA WHERE DATEDIFF(M,CLOSEDATE,PROP_DISTINCT_CALCS.LOANORIGDATE)<=3)

UPDATE PROP_DISTINCT_CALCS SET HPI_2000=NULL,HPI_1YRCH=NULL
UPDATE PROP_DISTINCT_CALCS SET 
HPI_2000=(SELECT AVG(HPI_2000) FROM HPIDATA X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.ZIPCODE=PROP_DISTINCT_CALCS.PROPERTYZIPCODE),
HPI_1YRCH=(SELECT AVG(HPI_1YRCH) FROM HPIDATA X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.ZIPCODE=PROP_DISTINCT_CALCS.PROPERTYZIPCODE)
WHERE PROPERTYZIPCODE IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET 
HPI_1YRCH=(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.NCREIFMetro=PROP_DISTINCT_CALCS.NCREIFMetro),
HPI_2000=(SELECT HPI_2000 FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
			+(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.NCREIFMetro=PROP_DISTINCT_CALCS.NCREIFMetro)
WHERE HPI_1YRCH IS NULL
---
UPDATE PROP_DISTINCT_CALCS SET 
HPI_2000=(SELECT AVG(HPI_2000) FROM HPIDATA X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1 AND X.ZIPCODE=PROP_DISTINCT_CALCS.PROPERTYZIPCODE),
HPI_1YRCH=(SELECT AVG(HPI_1YRCH) FROM HPIDATA X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1 AND X.ZIPCODE=PROP_DISTINCT_CALCS.PROPERTYZIPCODE)
WHERE HPI_1YRCH IS NULL AND PROPERTYZIPCODE IS NOT NULL

UPDATE PROP_DISTINCT_CALCS SET 
HPI_1YRCH=(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1 AND X.NCREIFMetro=PROP_DISTINCT_CALCS.NCREIFMetro),
HPI_2000=(SELECT HPI_2000 FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-2)
			+(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1 AND X.NCREIFMetro=PROP_DISTINCT_CALCS.NCREIFMetro)
WHERE HPI_1YRCH IS NULL

UPDATE PROP_DISTINCT_CALCS SET 
HPI_1YRCH=0,
HPI_2000=(SELECT HPI_2000 FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=PROP_DISTINCT_CALCS.EXID_PLID_PRID AND X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR-1)
WHERE HPI_1YRCH IS NULL

---
UPDATE PROP_DISTINCT_CALCS SET HPI_METRO_1YRCH=(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.NCREIFMetro=PROP_DISTINCT_CALCS.NCREIFMetro)
UPDATE PROP_DISTINCT_CALCS SET HPI_METRO_1YRCH=(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.NCREIFDivision=PROP_DISTINCT_CALCS.NCREIFDivision) WHERE HPI_METRO_1YRCH IS NULL
UPDATE PROP_DISTINCT_CALCS SET HPI_METRO_1YRCH=(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR AND X.NCREIFRegion=PROP_DISTINCT_CALCS.NCREIFRegion) WHERE HPI_METRO_1YRCH IS NULL
UPDATE PROP_DISTINCT_CALCS SET HPI_METRO_1YRCH=(SELECT AVG(HPI_1YRCH) FROM PROP_DISTINCT_CALCS X WHERE X.STATEMENTYEAR=PROP_DISTINCT_CALCS.STATEMENTYEAR) WHERE HPI_METRO_1YRCH IS NULL
UPDATE PROP_DISTINCT_CALCS SET HPI_METRO_1YRCH=0 WHERE HPI_METRO_1YRCH IS NULL

UPDATE PROP_DISTINCT_CALCS SET 
RevenuePctMedianIncome=12*REV_PERUNIT/MedianHHInc
WHERE MedianHHInc>0

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=NULL

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=
CASE WHEN RevenuePctMedianIncome<.12 THEN 'AFFORDABLE(40% AMI)'
	ELSE CASE WHEN RevenuePctMedianIncome<.15 THEN 'AFFORDABLE(50% AMI)'
			ELSE CASE WHEN RevenuePctMedianIncome<.18 THEN 'AFFORDABLE(60% AMI)'
END END END

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=CASE WHEN LOWINCOMESTATUS IS NULL THEN (CASE WHEN HUD_PROJECT_NUMBER>0 THEN 'AFFORDABLE:HUD Loan' END) 
	ELSE CONCAT(LOWINCOMESTATUS,(CASE WHEN HUD_PROJECT_NUMBER>0 THEN ', HUD Loan' END)) END

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=CASE WHEN LOWINCOMESTATUS IS NULL THEN (CASE WHEN SEC8_PROPERTYID>0 THEN 'AFFORDABLE:Section 8' END) 
	ELSE CONCAT(LOWINCOMESTATUS,(CASE WHEN SEC8_PROPERTYID>0 THEN ', Section 8' END)) END

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=CASE WHEN LOWINCOMESTATUS IS NULL THEN (CASE WHEN LOWINCOMEUNITS>.5*NUMUNITS and (VERYLOWINCOMEUNITS IS NULL OR VERYLOWINCOMEUNITS<LOWINCOMEUNITS) THEN CONCAT('AFFORDABLE: ',CAST((100*LOWINCOMEUNITS)/NUMUNITS AS INT),'% Low Income Units') END)
	ELSE CONCAT(LOWINCOMESTATUS,(CASE WHEN LOWINCOMEUNITS>.1*NUMUNITS and (VERYLOWINCOMEUNITS IS NULL OR VERYLOWINCOMEUNITS<LOWINCOMEUNITS) THEN CONCAT(', ',CAST((100*LOWINCOMEUNITS)/NUMUNITS AS INT),'% Low Income Units') END)) END

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=CASE WHEN LOWINCOMESTATUS IS NULL THEN (CASE WHEN VERYLOWINCOMEUNITS>.1*NUMUNITS THEN CONCAT('AFFORDABLE: ',CAST((100*VERYLOWINCOMEUNITS)/NUMUNITS AS INT),'% Very Low Income Units') END)
	ELSE CONCAT(LOWINCOMESTATUS,(CASE WHEN VERYLOWINCOMEUNITS>.05*NUMUNITS THEN CONCAT(', ',CAST((100*VERYLOWINCOMEUNITS)/NUMUNITS AS INT),'% Very Low Income Units') END)) END

UPDATE PROP_DISTINCT_CALCS SET 
LOWINCOMESTATUS=CASE WHEN RevenuePctMedianIncome>0 THEN 'MARKETRATE' ELSE 'N/A' END
WHERE LOWINCOMESTATUS IS NULL

UPDATE PROP_DISTINCT_CALCS SET
LOWINCOMESTATUS=CONCAT(LOWINCOMESTATUS,', RevPctInc=',
	CASE WHEN RevenuePctMedianIncome>0 THEN CONCAT(CAST(100*RevenuePctMedianIncome AS INT),'%')
		ELSE 'N/A' END)

UPDATE PROP_DISTINCT_CALCS SET PROPERTY_NAME_AND_ATTRIBUTES=CONCAT(PROPERTYNAME,', ',PROPERTYADDRESS,', ',PROPERTYCITY,', ',PROPERTYSTATE,', ',
		CASE WHEN PROPERTYSUBTYPE_ASSIGNED='GARDEN(SB)' THEN 'GARDEN' ELSE CASE WHEN PROPERTYSUBTYPE_ASSIGNED='MIRISE(SB)' THEN 'MIDRISE' ELSE PROPERTYSUBTYPE_ASSIGNED END END,
		' Subtype, ',NUMUNITS,' Units, ', YearBuilt,' Built',CASE WHEN YearRenov>YearBuilt THEN CONCAT(', ',YearRenov,' Renovated') END,CASE WHEN LOWINCOMESTATUS IS NOT NULL THEN CONCAT(',',LOWINCOMESTATUS) END)

UPDATE PROP_DISTINCT_CALCS SET DATA_AVAILABLE=PROPERTY_NAME_AND_ATTRIBUTES
UPDATE PROP_DISTINCT_CALCS SET DATA_AVAILABLE=CONCAT(DATA_AVAILABLE,CASE WHEN FFYEAR_MOSTRECENT=2021 THEN ', 2021 Operating Statement' ELSE CASE WHEN REVYEAR_MOSTRECENT=2021 THEN ', 2021 Top-Line Financials' END END)
UPDATE PROP_DISTINCT_CALCS SET DATA_AVAILABLE=CONCAT(DATA_AVAILABLE,CASE WHEN FFYEAR_MOSTRECENT=2020 THEN ', 2020 Operating Statement' ELSE CASE WHEN REVYEAR_MOSTRECENT=2020 THEN ', 2020 Top-Line Financials' END END)
UPDATE PROP_DISTINCT_CALCS SET DATA_AVAILABLE=CONCAT(DATA_AVAILABLE,CASE WHEN UWYEAR_MOSTRECENT=2021 THEN ', 2021 Appraisal' ELSE CASE WHEN UWYEAR_MOSTRECENT=2020 THEN ', 2020 Appraisal' ELSE CASE WHEN UWYEAR_MOSTRECENT=2019 THEN ', 2019 Appraisal' ELSE CASE WHEN UWYEAR_MOSTRECENT=2018 THEN ', 2018 Appraisal' END END END END)

---DATANUM

UPDATE PROP_DISTINCT_CALCS SET 
DATANUM=CASE WHEN 
--MODEL 3
ABS(REV_1YR_PCT_CH)<.5
AND ABS(EXP_1YR_PCT_CH)<.5
AND ABS(NOI_1YR_PCT_CH)<1
AND YearBuiltRenov IS NOT NULL
AND PopulationPerSqMile IS NOT NULL
AND MedianHHInc IS NOT NULL
AND MedianHomeVal IS NOT NULL
AND Median_Rent IS NOT NULL
AND MedianAge IS NOT NULL
AND Median_Owner_Costs IS NOT NULL
AND RenterPCT IS NOT NULL
AND CashRentOver30PCT IS NOT NULL
AND BachelorsOrMorePCT IS NOT NULL
AND UnemploymentPCT IS NOT NULL
AND MngtFinancePCT IS NOT NULL
AND MovedIn2010orLaterPCT IS NOT NULL
AND HPI_1YRCH IS NOT NULL
AND OCCUP IS NOT NULL
AND REV_PERUNIT IS NOT NULL
AND EXP_PCTREV IS NOT NULL
AND CAPEX0_PCTREV IS NOT NULL
AND OCCUP_1YRCH IS NOT NULL
AND REV_1YR_PCT_CH IS NOT NULL
AND EXP_1YR_PCT_CH IS NOT NULL
AND YearBuilt IS NOT NULL
AND NumUnits IS NOT NULL
AND RevenuePctMedianIncome IS NOT NULL
AND NOI_1YR_PCT_CH IS NOT NULL
AND HPI_METRO_1YRCH IS NOT NULL
AND RETAXES_PCTREV IS NOT NULL
AND PROPINS_PCTREV IS NOT NULL
AND UTILITI_PCTREV IS NOT NULL
AND REPAIRS_PCTREV IS NOT NULL
AND MANAGEM_PCTREV IS NOT NULL
AND PAYROLL_PCTREV IS NOT NULL
THEN 3


ELSE CASE WHEN
--MODEL 2
--AND ABS(REV_1YR_PCT_CH)<.5
--AND ABS(EXP_1YR_PCT_CH)<.5
--AND ABS(NOI_1YR_PCT_CH)<1
YearBuiltRenov IS NOT NULL
AND PopulationPerSqMile IS NOT NULL
AND MedianHHInc IS NOT NULL
AND MedianHomeVal IS NOT NULL
AND Median_Rent IS NOT NULL
AND MedianAge IS NOT NULL
AND Median_Owner_Costs IS NOT NULL
AND RenterPCT IS NOT NULL
AND CashRentOver30PCT IS NOT NULL
AND BachelorsOrMorePCT IS NOT NULL
AND UnemploymentPCT IS NOT NULL
AND MngtFinancePCT IS NOT NULL
AND MovedIn2010orLaterPCT IS NOT NULL
AND HPI_1YRCH IS NOT NULL
--AND OCCUP IS NOT NULL
AND REV_PERUNIT IS NOT NULL
AND EXP_PCTREV IS NOT NULL
AND CAPEX0_PCTREV IS NOT NULL
--AND OCCUP_1YRCH IS NOT NULL
--AND REV_1YR_PCT_CH IS NOT NULL
--AND EXP_1YR_PCT_CH IS NOT NULL
--AND YearBuilt IS NOT NULL
AND NumUnits IS NOT NULL
AND RevenuePctMedianIncome IS NOT NULL
--AND NOI_1YR_PCT_CH IS NOT NULL
AND HPI_METRO_1YRCH IS NOT NULL
AND RETAXES_PCTREV IS NOT NULL
AND PROPINS_PCTREV IS NOT NULL
AND UTILITI_PCTREV IS NOT NULL
AND REPAIRS_PCTREV IS NOT NULL
AND MANAGEM_PCTREV IS NOT NULL
AND PAYROLL_PCTREV IS NOT NULL
THEN 2

ELSE CASE WHEN 
--MODEL 1
--AND ABS(REV_1YR_PCT_CH)<.5
--AND ABS(EXP_1YR_PCT_CH)<.5
--AND ABS(NOI_1YR_PCT_CH)<1
YearBuiltRenov IS NOT NULL
AND PopulationPerSqMile IS NOT NULL
AND MedianHHInc IS NOT NULL
AND MedianHomeVal IS NOT NULL
AND Median_Rent IS NOT NULL
AND MedianAge IS NOT NULL
AND Median_Owner_Costs IS NOT NULL
AND RenterPCT IS NOT NULL
AND CashRentOver30PCT IS NOT NULL
AND BachelorsOrMorePCT IS NOT NULL
AND UnemploymentPCT IS NOT NULL
AND MngtFinancePCT IS NOT NULL
AND MovedIn2010orLaterPCT IS NOT NULL
AND HPI_1YRCH IS NOT NULL
--AND OCCUP IS NOT NULL
AND REV_PERUNIT IS NOT NULL
AND EXP_PCTREV IS NOT NULL
AND CAPEX0_PCTREV IS NOT NULL
--AND OCCUP_1YRCH IS NOT NULL
--AND REV_1YR_PCT_CH IS NOT NULL
--AND EXP_1YR_PCT_CH IS NOT NULL
--AND YearBuilt IS NOT NULL
AND NumUnits IS NOT NULL
AND RevenuePctMedianIncome IS NOT NULL
--AND NOI_1YR_PCT_CH IS NOT NULL
AND HPI_METRO_1YRCH IS NOT NULL
--AND RETAXES_PCTREV IS NOT NULL
--AND PROPINS_PCTREV IS NOT NULL
--AND UTILITI_PCTREV IS NOT NULL
--AND REPAIRS_PCTREV IS NOT NULL
--AND MANAGEM_PCTREV IS NOT NULL
--AND PAYROLL_PCTREV IS NOT NULL
THEN 1

ELSE CASE WHEN
--MODEL 0
--AND ABS(REV_1YR_PCT_CH)<.5
--AND ABS(EXP_1YR_PCT_CH)<.5
--AND ABS(NOI_1YR_PCT_CH)<1
YearBuiltRenov IS NOT NULL
AND PopulationPerSqMile IS NOT NULL
AND MedianHHInc IS NOT NULL
AND MedianHomeVal IS NOT NULL
AND Median_Rent IS NOT NULL
AND MedianAge IS NOT NULL
AND Median_Owner_Costs IS NOT NULL
AND RenterPCT IS NOT NULL
AND CashRentOver30PCT IS NOT NULL
AND BachelorsOrMorePCT IS NOT NULL
AND UnemploymentPCT IS NOT NULL
AND MngtFinancePCT IS NOT NULL
AND MovedIn2010orLaterPCT IS NOT NULL
AND HPI_1YRCH IS NOT NULL
--AND OCCUP IS NOT NULL
--AND REV_PERUNIT IS NOT NULL
--AND EXP_PCTREV IS NOT NULL
--AND CAPEX_PCTREV IS NOT NULL
--AND OCCUP_1YRCH IS NOT NULL
--AND REV_1YR_PCT_CH IS NOT NULL
--AND EXP_1YR_PCT_CH IS NOT NULL
--AND YearBuilt IS NOT NULL
AND NumUnits IS NOT NULL
--AND RevenuePctMedianIncome IS NOT NULL
--AND NOI_1YR_PCT_CH IS NOT NULL
AND HPI_METRO_1YRCH IS NOT NULL
--AND RETAXES_PCTREV IS NOT NULL
--AND PROPINS_PCTREV IS NOT NULL
--AND UTILITI_PCTREV IS NOT NULL
--AND REPAIRS_PCTREV IS NOT NULL
--AND MANAGEM_PCTREV IS NOT NULL
--AND PAYROLL_PCTREV IS NOT NULL
THEN 0
ELSE -99 END END END END

TRUNCATE TABLE PROP_DISTINCT_CALCS_MOSTRECENT
INSERT INTO PROP_DISTINCT_CALCS_MOSTRECENT
SELECT * FROM PROP_DISTINCT_CALCS P WHERE STATEMENTYEAR=(SELECT MAX(STATEMENTYEAR) FROM PROP_DISTINCT_CALCS X WHERE X.EXID_PLID_PRID=P.EXID_PLID_PRID)


END TRY

BEGIN CATCH
    SELECT 
     ERROR_NUMBER() AS ErrorNumber
    ,ERROR_SEVERITY() AS ErrorSeverity
    ,ERROR_STATE() AS ErrorState
    ,ERROR_PROCEDURE() AS ErrorProcedure
    ,ERROR_LINE() AS ErrorLine
    ,ERROR_MESSAGE() AS ErrorMessage
END CATCH

END